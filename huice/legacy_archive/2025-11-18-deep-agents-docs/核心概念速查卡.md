# DeepAgents æ ¸å¿ƒæ¦‚å¿µé€ŸæŸ¥å¡ ğŸš€

## ä¸€å¥è¯æ€»ç»“

### SubAgent çš„æœ¬è´¨
**SubAgent é…ç½®ï¼ˆå­—å…¸ï¼‰ â†’ `create_agent` â†’ çœŸæ­£çš„ Agent â†’ å­˜å‚¨åœ¨é—­åŒ…ä¸­ â†’ è¿è¡Œæ—¶è°ƒç”¨**

### Backend çš„æœ¬è´¨
**ç»Ÿä¸€æ¥å£ï¼ˆBackendProtocolï¼‰ â†’ å¤šç§å®ç°ï¼ˆState/Store/Sandbox/Compositeï¼‰ â†’ å¯æ’æ‹”è®¾è®¡**

---

## SubAgent æ ¸å¿ƒè¦ç‚¹

### åˆ›å»ºæµç¨‹
```
1. ç”¨æˆ·å®šä¹‰é…ç½® (TypedDict)
   â†“
2. SubAgentMiddleware.__init__
   â†“
3. _get_subagents å‡½æ•°
   â†“
4. create_agent(model, system_prompt, tools, middleware)  â† ğŸ”¥ å…³é”®
   â†“
5. CompiledStateGraph (çœŸæ­£çš„ Agent)
   â†“
6. å­˜å‚¨åœ¨ subagent_graphs å­—å…¸
   â†“
7. task å·¥å…·çš„é—­åŒ…æ•è·
   â†“
8. è¿è¡Œæ—¶: subagent.invoke(state)  â† ğŸ”¥ å…³é”®
```

### å…³é”®ä»£ç ä½ç½®
```python
# deepagents2/middleware/subagents.py

# ç¬¬ 6 è¡Œ: å¯¼å…¥ create_agent
from langchain.agents import create_agent

# ç¬¬ 244 è¡Œ: åˆ›å»ºé€šç”¨å­æ™ºèƒ½ä½“
general_purpose_subagent = create_agent(
    default_model,
    system_prompt=DEFAULT_SUBAGENT_PROMPT,
    tools=default_tools,
    middleware=general_purpose_middleware,
)

# ç¬¬ 270 è¡Œ: åˆ›å»ºè‡ªå®šä¹‰å­æ™ºèƒ½ä½“
agents[agent_["name"]] = create_agent(
    subagent_model,
    system_prompt=agent_["system_prompt"],
    tools=_tools,
    middleware=_middleware,
)

# ç¬¬ 348 è¡Œ: è¿è¡Œæ—¶è°ƒç”¨
result = subagent.invoke(subagent_state)
```

### çŠ¶æ€éš”ç¦»
```python
# ç¬¬ 64 è¡Œ: æ’é™¤çš„çŠ¶æ€é”®
_EXCLUDED_STATE_KEYS = ("messages", "todos")

# ç¬¬ 328 è¡Œ: åˆ›å»ºéš”ç¦»çš„çŠ¶æ€
subagent_state = {
    k: v for k, v in runtime.state.items() 
    if k not in _EXCLUDED_STATE_KEYS
}
subagent_state["messages"] = [HumanMessage(content=description)]
```

---

## Backend æ ¸å¿ƒè¦ç‚¹

### æ¥å£å®šä¹‰
```python
# deepagents2/backends/protocol.py

class BackendProtocol(Protocol):
    def ls_info(self, path: str) -> list[FileInfo]: ...
    def read(self, file_path: str, offset: int = 0, limit: int = 2000) -> str: ...
    def write(self, file_path: str, content: str) -> WriteResult: ...
    def edit(self, file_path: str, old_string: str, new_string: str) -> EditResult: ...
    def grep_raw(self, pattern: str, path: str | None = None) -> list[GrepMatch]: ...
    def glob_info(self, pattern: str, path: str = "/") -> list[FileInfo]: ...
```

### files_update å­—æ®µ
```python
# è¿”å› dict: æ–‡ä»¶æ•°æ®æ›´æ–°åˆ° State
WriteResult(
    path="/test.txt",
    files_update={"/test.txt": {"content": [...], "modified_at": "..."}}
)
# â†’ LangGraph å°† files_update åˆå¹¶åˆ° state["files"]
# â†’ Checkpointer è‡ªåŠ¨æŒä¹…åŒ–

# è¿”å› None: æ–‡ä»¶å·²å­˜å‚¨åˆ°å¤–éƒ¨
WriteResult(
    path="/test.txt",
    files_update=None
)
# â†’ æ–‡ä»¶å·²ç»å­˜å‚¨åˆ° Store/æ–‡ä»¶ç³»ç»Ÿ/æ•°æ®åº“
# â†’ ä¸éœ€è¦æ›´æ–° State
```

### å››ç§å®ç°å¯¹æ¯”

| Backend | å­˜å‚¨ä½ç½® | files_update | è·¨ä¼šè¯ | æ‰§è¡Œå‘½ä»¤ |
|---------|---------|--------------|--------|----------|
| StateBackend | Agent State | dict | âŒ | âŒ |
| StoreBackend | LangGraph Store | None | âœ… | âŒ |
| SandboxBackend | æ²™ç®±ç¯å¢ƒ | None | âœ… | âœ… |
| CompositeBackend | æ··åˆè·¯ç”± | å–å†³äºè·¯ç”± | âœ… | âœ… |

---

## å¿«é€Ÿé…ç½®æ¨¡æ¿

### 1. åŸºç¡€é…ç½®ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
```python
from deepagents2 import create_deep_agent
from deepagents2.middleware.filesystem import FilesystemMiddleware
from deepagents2.backends.state import StateBackend
from langgraph.checkpoint.memory import MemorySaver

agent = create_deep_agent(
    model="openai:gpt-4o-mini",
    middleware=[
        FilesystemMiddleware(backend=lambda rt: StateBackend(rt))
    ],
    checkpointer=MemorySaver(),
)
```

### 2. ç”Ÿäº§é…ç½®ï¼ˆæŒä¹…å­˜å‚¨ï¼‰
```python
from deepagents2.backends.store import StoreBackend
from langgraph.store.memory import InMemoryStore

store = InMemoryStore()  # ç”Ÿäº§ç¯å¢ƒç”¨ PostgresStore

agent = create_deep_agent(
    model="openai:gpt-4o-mini",
    middleware=[
        FilesystemMiddleware(
            backend=lambda rt: StoreBackend(rt, namespace=("user-files",))
        )
    ],
    checkpointer=MemorySaver(),
    store=store,
)
```

### 3. ä¼ä¸šé…ç½®ï¼ˆSubAgent + CompositeBackendï¼‰
```python
from deepagents2.middleware.subagents import SubAgentMiddleware
from deepagents2.backends.composite import CompositeBackend

subagents = [
    {
        "name": "code-analyzer",
        "description": "ä»£ç åˆ†æä¸“å®¶",
        "system_prompt": "ä½ æ˜¯ä»£ç åˆ†æä¸“å®¶...",
        "tools": [],
    }
]

agent = create_deep_agent(
    model="openai:gpt-4o-mini",
    middleware=[
        FilesystemMiddleware(
            backend=CompositeBackend(
                default=lambda rt: StateBackend(rt),
                routes={
                    "/memories/": lambda rt: StoreBackend(rt, namespace=("memories",)),
                    "/projects/": lambda rt: StoreBackend(rt, namespace=("projects",)),
                }
            )
        ),
        SubAgentMiddleware(
            default_model="openai:gpt-4o-mini",
            subagents=subagents,
            general_purpose_agent=True,
        ),
    ],
    checkpointer=MemorySaver(),
    store=InMemoryStore(),
)
```

---

## è®¾è®¡æ¨¡å¼é€ŸæŸ¥

### SubAgent ä½¿ç”¨çš„æ¨¡å¼
- **å·¥å‚æ¨¡å¼**: `_get_subagents` æ ¹æ®é…ç½®åˆ›å»º Agent
- **ç­–ç•¥æ¨¡å¼**: ä¸åŒçš„ SubAgent æ˜¯ä¸åŒçš„ç­–ç•¥
- **é—­åŒ…æ¨¡å¼**: `task` å·¥å…·æ•è· `subagent_graphs`

### Backend ä½¿ç”¨çš„æ¨¡å¼
- **ç­–ç•¥æ¨¡å¼**: `BackendProtocol` å®šä¹‰æ¥å£ï¼Œå¤šç§å®ç°
- **é€‚é…å™¨æ¨¡å¼**: `FilesystemMiddleware` é€‚é…ä¸åŒ Backend
- **ç»„åˆæ¨¡å¼**: `CompositeBackend` ç»„åˆå¤šä¸ª Backend
- **å·¥å‚æ¨¡å¼**: `BackendFactory` åˆ›å»º Backend å®ä¾‹

---

## å¸¸è§é—®é¢˜é€ŸæŸ¥

### Q: SubAgent å’Œæ™®é€šå‡½æ•°æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ
**A**: SubAgent æ˜¯å®Œæ•´çš„ Agentï¼Œå¯ä»¥å¤šè½®æ¨ç†å’Œè°ƒç”¨å·¥å…·ï¼›å‡½æ•°åªèƒ½æ‰§è¡Œä¸€æ¬¡ã€‚

### Q: ä»€ä¹ˆæ—¶å€™ç”¨ StateBackendï¼Œä»€ä¹ˆæ—¶å€™ç”¨ StoreBackendï¼Ÿ
**A**: 
- StateBackend: ä¸´æ—¶æ–‡ä»¶ã€å•ä¼šè¯ã€å¼€å‘æµ‹è¯•
- StoreBackend: é•¿æœŸè®°å¿†ã€è·¨ä¼šè¯ã€ç”¨æˆ·åå¥½

### Q: files_update è¿”å› dict å’Œ None æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ
**A**:
- dict: æ–‡ä»¶æ•°æ®æ›´æ–°åˆ° Stateï¼Œé€šè¿‡ Checkpointer æŒä¹…åŒ–
- None: æ–‡ä»¶å·²å­˜å‚¨åˆ°å¤–éƒ¨ç³»ç»Ÿï¼ˆStore/æ–‡ä»¶ç³»ç»Ÿ/æ•°æ®åº“ï¼‰

### Q: å¦‚ä½•è‡ªå®šä¹‰ Backendï¼Ÿ
**A**: å®ç° `BackendProtocol` æ¥å£çš„æ‰€æœ‰æ–¹æ³•å³å¯ã€‚

---

## ç›¸å…³æ–‡æ¡£

- **SubAgentå’ŒBackendæœ¬è´¨è§£æ.md**: å®Œæ•´çš„æ·±åº¦è§£æï¼ˆå«æºç åˆ†æï¼‰
- **SubAgentå’ŒBackendå®æˆ˜ç¤ºä¾‹.py**: å¯è¿è¡Œçš„ä»£ç ç¤ºä¾‹
- **DeepAgentsæ¡†æ¶æ·±åº¦è§£æ.md**: å®Œæ•´çš„æ¡†æ¶æ–‡æ¡£
- **DeepAgentså¿«é€Ÿå‚è€ƒ.md**: é€ŸæŸ¥æ‰‹å†Œ

---

**ğŸ¯ è®°ä½è¿™ä¸¤ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼Œæ‚¨å°±æŒæ¡äº† DeepAgents æ¡†æ¶çš„ç²¾é«“ï¼**
