# Chat-to-DB 架构与技术栈详解

## 一、系统架构总览

### 1.1 分层架构
```
┌─────────────────────────────────────────────────────────────┐
│                    表现层 (Presentation)                    │
│  ┌──────────────────────┬──────────────────────────────┐   │
│  │  Chat UI (Next.js)   │    Admin UI (React)         │   │
│  │  - 对话界面          │    - 管理界面               │   │
│  │  - 流式输出          │    - 数据可视化             │   │
│  │  - 结果展示          │    - 知识图谱               │   │
│  └──────────────────────┴──────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                    应用层 (Application)                     │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  API网关 (FastAPI)                                  │  │
│  │  - admin_server.py (8000)                           │  │
│  │  - chat_server.py (2025)                            │  │
│  └──────────────────────────────────────────────────────┘  │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  业务逻辑层                                          │  │
│  │  ┌────────────────────────────────────────────────┐ │  │
│  │  │ 多代理系统 (LangGraph Supervisor)             │ │  │
│  │  │ - Schema Agent                                │ │  │
│  │  │ - Sample Retrieval Agent                      │ │  │
│  │  │ - SQL Generator Agent                         │ │  │
│  │  │ - SQL Validator Agent                         │ │  │
│  │  │ - SQL Executor Agent                          │ │  │
│  │  │ - Error Recovery Agent                        │ │  │
│  │  │ - Chart Generator Agent                       │ │  │
│  │  └────────────────────────────────────────────────┘ │  │
│  │                                                      │  │
│  │  ┌────────────────────────────────────────────────┐ │  │
│  │  │ 混合检索系统                                   │ │  │
│  │  │ - 向量检索 (Milvus)                           │ │  │
│  │  │ - 结构检索 (Neo4j)                            │ │  │
│  │  │ - 模式检索 (Neo4j)                            │ │  │
│  │  │ - 融合排序                                    │ │  │
│  │  └────────────────────────────────────────────────┘ │  │
│  │                                                      │  │
│  │  ┌────────────────────────────────────────────────┐ │  │
│  │  │ 业务服务                                       │ │  │
│  │  │ - DB Service                                  │ │  │
│  │  │ - Schema Service                              │ │  │
│  │  │ - Text2SQL Service                            │ │  │
│  │  └────────────────────────────────────────────────┘ │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                    数据访问层 (Data Access)                 │
│  - CRUD操作                                                 │
│  - 数据库连接管理                                           │
│  - Schema管理                                               │
│  - 值映射管理                                               │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                    数据存储层 (Data Storage)                │
│  ┌──────────────┬──────────────┬──────────────────────┐   │
│  │   MySQL      │    Neo4j     │      Milvus         │   │
│  │  业务数据    │   知识图谱   │     向量库          │   │
│  └──────────────┴──────────────┴──────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 模块间通信
```
前端 (Chat/Admin UI)
   ↓ HTTP/WebSocket
API Gateway (FastAPI)
   ↓
LangGraph Supervisor
   ├─ 调用 → Worker Agents
   ├─ 调用 → Services
   └─ 调用 → CRUD
   ↓
数据库 (MySQL/Neo4j/Milvus)
```

---

## 二、技术栈详解

### 2.1 后端技术栈

#### 2.1.1 核心框架
| 技术 | 版本 | 用途 |
|------|------|------|
| Python | 3.11+ | 编程语言 |
| FastAPI | ~0.118.0 | Web框架 |
| Uvicorn | ~0.37.0 | ASGI服务器 |
| Pydantic | ~2.11.9 | 数据验证 |

#### 2.1.2 AI/ML框架
| 技术 | 版本 | 用途 |
|------|------|------|
| LangChain | ~0.3.77 | LLM框架 |
| LangGraph | ~0.6.10 | 代理编排 |
| LangChain-OpenAI | ~0.3.34 | OpenAI集成 |
| LangChain-DeepSeek | ~0.1.4 | DeepSeek集成 |
| LangChain-Ollama | ~0.3.10 | Ollama集成 |
| LangChain-MCP | ~0.1.11 | MCP适配器 |

#### 2.1.3 数据库驱动
| 技术 | 版本 | 用途 |
|------|------|------|
| SQLAlchemy | ~2.0.43 | ORM框架 |
| PyMySQL | ~1.1.2 | MySQL驱动 |
| Neo4j | ~6.0.2 | Neo4j驱动 |
| PyMilvus | ~2.6.2 | Milvus驱动 |

#### 2.1.4 数据处理
| 技术 | 版本 | 用途 |
|------|------|------|
| Pandas | ~2.3.3 | 数据处理 |
| NumPy | ~2.3.3 | 数值计算 |
| SQLParse | ~0.5.3 | SQL解析 |

#### 2.1.5 工具库
| 技术 | 版本 | 用途 |
|------|------|------|
| Requests | ~2.32.5 | HTTP客户端 |
| Passlib | ~1.7.4 | 密码加密 |
| python-dotenv | - | 环境变量 |

### 2.2 前端技术栈

#### 2.2.1 Chat UI (Next.js)
| 技术 | 版本 | 用途 |
|------|------|------|
| Next.js | ^15.2.3 | React框架 |
| React | ^19.0.0 | UI库 |
| TypeScript | ~5.7.2 | 类型系统 |
| Tailwind CSS | ^4.0.13 | 样式框架 |
| Radix UI | 最新 | UI组件库 |
| Framer Motion | ^12.4.9 | 动画库 |
| Axios | ^1.12.2 | HTTP客户端 |
| Recharts | ^2.15.1 | 图表库 |

#### 2.2.2 Admin UI (React)
| 技术 | 版本 | 用途 |
|------|------|------|
| React | ^18.2.0 | UI库 |
| React Router | ^6.8.1 | 路由 |
| Ant Design | ^5.2.2 | UI组件库 |
| AntV G6 | ^5.0.49 | 图谱可视化 |
| ReactFlow | ^11.11.4 | 流程图 |
| Chart.js | ^4.5.0 | 图表库 |
| Axios | ^1.3.4 | HTTP客户端 |

### 2.3 数据库技术栈

| 数据库 | 版本 | 用途 |
|--------|------|------|
| MySQL | 5.7+ | 业务数据存储 |
| Neo4j | 4.0+ | 知识图谱存储 |
| Milvus | 2.0+ | 向量数据库 |

### 2.4 外部服务

| 服务 | 用途 |
|------|------|
| DeepSeek API | LLM推理 |
| Ollama | 本地向量化 |
| LangSmith | 代理监控 |

---

## 三、核心模块架构

### 3.1 多代理系统架构
```
┌─────────────────────────────────────────┐
│    LangGraph Supervisor                 │
│  (langgraph_supervisor.create_supervisor)│
└─────────────────────────────────────────┘
         ↓
┌─────────────────────────────────────────┐
│    Worker Agents (7个)                  │
├─────────────────────────────────────────┤
│ 1. schema_agent.py                      │
│    - 分析查询                           │
│    - 获取Schema                         │
│                                         │
│ 2. sample_retrieval_agent.py            │
│    - 混合检索                           │
│    - 返回样本                           │
│                                         │
│ 3. sql_generator_agent.py               │
│    - 生成SQL                            │
│    - 应用值映射                         │
│                                         │
│ 4. sql_validator_agent.py               │
│    - 验证SQL                            │
│    - 检查安全性                         │
│                                         │
│ 5. sql_executor_agent.py                │
│    - 执行SQL                            │
│    - 获取结果                           │
│                                         │
│ 6. error_recovery_agent.py              │
│    - 分析错误                           │
│    - 修复SQL                            │
│                                         │
│ 7. chart_generator_agent.py             │
│    - 生成图表                           │
│    - 优化展示                           │
└─────────────────────────────────────────┘
```

### 3.2 混合检索系统架构
```
┌──────────────────────────────────────────┐
│   HybridRetrievalEngine                  │
│   (hybrid_retrieval_service.py)          │
└──────────────────────────────────────────┘
         ↓
    ┌────┴────┬────────┬────────┐
    ↓         ↓        ↓        ↓
┌────────┐ ┌──────┐ ┌──────┐ ┌──────┐
│语义    │ │结构  │ │模式  │ │缓存  │
│检索    │ │检索  │ │检索  │ │查询  │
│        │ │      │ │      │ │      │
│Vector  │ │Neo4j │ │Neo4j │ │Redis │
│Service │ │      │ │      │ │      │
│        │ │      │ │      │ │      │
│Milvus  │ │      │ │      │ │      │
└────────┘ └──────┘ └──────┘ └──────┘
    ↓         ↓        ↓        ↓
    └────┬────┴────┬───┴────┬───┘
         ↓         ↓        ↓
    ┌──────────────────────────┐
    │   FusionRanker           │
    │ - 动态权重调整           │
    │ - 质量评分               │
    │ - 最终排序               │
    └──────────────────────────┘
         ↓
    ┌──────────────────────────┐
    │   返回Top-K结果          │
    └──────────────────────────┘
```

### 3.3 数据流架构
```
用户输入
   ↓
Chat UI (Next.js)
   ↓ HTTP POST
FastAPI (admin_server:8000)
   ↓
LangGraph Supervisor
   ├─ Schema Agent → MySQL (获取Schema)
   ├─ Sample Retrieval Agent → Milvus + Neo4j (检索样本)
   ├─ SQL Generator Agent → DeepSeek API (生成SQL)
   ├─ SQL Validator Agent → 本地验证
   ├─ SQL Executor Agent → 目标数据库 (执行SQL)
   ├─ Error Recovery Agent → 错误处理
   └─ Chart Generator Agent → 生成图表
   ↓
结果聚合
   ↓ HTTP Response
Chat UI (展示结果)
```

---

## 四、关键技术决策

### 4.1 为什么选择LangGraph?
1. **原生支持**: LangChain官方推荐的代理编排框架
2. **灵活性**: 支持复杂的工作流程和条件分支
3. **可视化**: 支持图形化调试和监控
4. **性能**: 优化的执行引擎

### 4.2 为什么选择Neo4j?
1. **关系表示**: 天然支持复杂的关系
2. **图查询**: 高效的Cypher查询语言
3. **知识图谱**: 完美支持知识表示
4. **可视化**: 内置图形化工具

### 4.3 为什么选择Milvus?
1. **向量搜索**: 专业的向量数据库
2. **性能**: 毫秒级的相似度搜索
3. **可扩展性**: 支持大规模数据
4. **多种索引**: IVF_FLAT, HNSW等

### 4.4 为什么选择Ollama?
1. **本地化**: 支持本地部署
2. **隐私**: 数据不上传云端
3. **成本**: 无API调用费用
4. **灵活性**: 支持多种模型

---

## 五、部署架构

### 5.1 开发环境
```
localhost:3000   ← Chat UI (Next.js dev server)
localhost:3001   ← Admin UI (React dev server)
localhost:8000   ← Admin API (FastAPI)
localhost:2025   ← LangGraph API
localhost:3306   ← MySQL
localhost:7687   ← Neo4j
localhost:19530  ← Milvus
localhost:11434  ← Ollama
```

### 5.2 生产环境
```
┌─────────────────────────────────────────┐
│         Nginx (反向代理)                │
│         :80, :443                       │
└─────────────────────────────────────────┘
         ↓
┌─────────────────────────────────────────┐
│    Docker容器编排 (Docker Compose)      │
├─────────────────────────────────────────┤
│ - Chat UI (Next.js)                     │
│ - Admin UI (React)                      │
│ - Admin API (FastAPI)                   │
│ - LangGraph API                         │
│ - MySQL                                 │
│ - Neo4j                                 │
│ - Milvus                                │
│ - Ollama                                │
└─────────────────────────────────────────┘
         ↓
┌─────────────────────────────────────────┐
│    监控和日志                           │
│ - Prometheus (指标)                     │
│ - ELK Stack (日志)                      │
│ - Grafana (可视化)                      │
└─────────────────────────────────────────┘
```

---

## 六、性能指标

### 6.1 目标性能
| 指标 | 目标 |
|------|------|
| 查询响应时间 | < 5秒 |
| 混合检索时间 | < 1秒 |
| SQL生成时间 | < 2秒 |
| 向量化时间 | < 500ms |
| 缓存命中率 | > 70% |

### 6.2 可扩展性
| 指标 | 支持 |
|------|------|
| 并发用户 | 1000+ |
| 数据库连接 | 100+ |
| 历史查询 | 1M+ |
| 向量维度 | 1024 |

---

## 七、安全性架构

### 7.1 认证授权
```
API请求
   ↓
API密钥验证
   ↓
用户权限检查
   ↓
数据库连接权限
   ↓
SQL执行权限
```

### 7.2 数据保护
```
密码加密 (Passlib)
   ↓
敏感数据脱敏
   ↓
审计日志
   ↓
访问控制
```

### 7.3 SQL安全
```
SQL注入防护 (参数化查询)
   ↓
查询验证 (sqlparse)
   ↓
执行权限控制
   ↓
结果脱敏
```

---

## 八、监控和日志

### 8.1 监控指标
- API响应时间
- 查询成功率
- 缓存命中率
- 向量化性能
- 数据库连接数

### 8.2 日志系统
- 结构化日志 (JSON)
- 日志级别 (DEBUG, INFO, WARNING, ERROR)
- 日志持久化 (文件/ELK)
- 日志聚合和分析

---

**文档版本**: 1.0
**最后更新**: 2025-10-16
