# åŸå§‹é¡¹ç›® vs å½“å‰é¡¹ç›® ä»£ç å¯¹æ¯”åˆ†ææŠ¥å‘Š

**æ—¥æœŸ**: 2025-12-05  
**åˆ†æç›®çš„**: éªŒè¯å½“å‰é¡¹ç›®çš„ä¿®æ”¹æ˜¯å¦å½±å“äº†åŸå§‹ä»£ç çš„å‡†ç¡®æ€§ã€æ•ˆç‡ã€æ™ºèƒ½æ€§

---

## ğŸ“Š å¯¹æ¯”æ€»ç»“

### æ ¸å¿ƒç»“è®º

| æ–¹é¢ | åŸå§‹é¡¹ç›® | å½“å‰é¡¹ç›® | è¯„ä¼° |
|------|---------|---------|------|
| **å‡†ç¡®æ€§** | âœ… åŸºç¡€åŠŸèƒ½ | âœ… å¢å¼ºåŠŸèƒ½ | âœ… æå‡ |
| **æ•ˆç‡** | âš ï¸ å•ä¸€æ¨¡å‹ | âœ… å¤šæ¨¡å‹ä¼˜åŒ– | âœ… æå‡ |
| **æ™ºèƒ½æ€§** | âš ï¸ æœ‰é™ | âœ… å®Œæ•´RAG | âœ… æ˜¾è‘—æå‡ |
| **ç¨³å®šæ€§** | âœ… ç¨³å®š | âœ… ç¨³å®š | âœ… ä¿æŒ |
| **å…¼å®¹æ€§** | - | âœ… å‘åå…¼å®¹ | âœ… ä¿æŒ |

---

## ğŸ” è¯¦ç»†å¯¹æ¯”åˆ†æ

### 1. Agent Service - LLM é…ç½®

#### åŸå§‹ä»£ç  (`huiceå´è¿ª/2025-11-22-agent-service/src/rag/chat/llms.py`)

```python
def deepseek_model():
    os.environ["DEEPSEEK_API_KEY"] = "sk-e995a95f08e14ff39904d41bbf54e742"
    model = init_chat_model("deepseek:deepseek-chat")
    return model
```

**ç‰¹ç‚¹**:
- âŒ ç¡¬ç¼–ç  API Key
- âŒ åªæ”¯æŒ DeepSeek
- âŒ æ— ç¯å¢ƒå˜é‡é…ç½®
- âŒ æ— é”™è¯¯å¤„ç†

#### å½“å‰ä»£ç  (`agent-service/src/rag/chat/llms.py`)

```python
def get_model():
    provider = os.getenv("LLM_PROVIDER", "deepseek").lower()
    
    if provider == "google":
        api_key = os.getenv("GOOGLE_API_KEY")
        return ChatGoogleGenerativeAI(
            model="gemini-2.0-flash",
            google_api_key=api_key,
            temperature=0
        )
    elif provider == "deepseek":
        api_key = os.getenv("DEEPSEEK_API_KEY") or "sk-e995a95f08e14ff39904d41bbf54e742"
        return ChatOpenAI(
            model="deepseek-chat",
            api_key=api_key,
            base_url="https://api.deepseek.com",
            temperature=0
        )
    else:
        raise ValueError(f"Unsupported LLM_PROVIDER: {provider}")

# å‘åå…¼å®¹
def deepseek_model():
    return get_model()
```

**æ”¹è¿›**:
- âœ… æ”¯æŒå¤šä¸ª LLM æä¾›å•†ï¼ˆGoogle, DeepSeekï¼‰
- âœ… ç¯å¢ƒå˜é‡é…ç½®
- âœ… é”™è¯¯å¤„ç†
- âœ… **å‘åå…¼å®¹** - `deepseek_model()` ä»ç„¶å¯ç”¨
- âœ… æ—¥å¿—è¾“å‡º

**å½±å“è¯„ä¼°**: âœ… **å¢å¼ºï¼Œæ— è´Ÿé¢å½±å“**

---

### 2. Chat UI - Thread ç»„ä»¶

#### åŸå§‹ä»£ç  (`huiceå´è¿ª/2025-11-22-notebook-chat-ui/src/components/thread/index.tsx`)

```typescript
const handleSubmit = (e: FormEvent) => {
  e.preventDefault();
  if ((input.trim().length === 0 && chatContentBlocks.length === 0) || isLoading)
    return;
  
  const newHumanMessage: Message = {
    id: uuidv4(),
    type: "human",
    content: [
      ...(input.trim().length > 0 ? [{ type: "text", text: input }] : []),
      ...chatContentBlocks,  // ç›´æ¥ä½¿ç”¨åŸå§‹ blocks
    ] as Message["content"],
  };
  
  stream.submit({ messages: [...toolMessages, newHumanMessage], context });
  setInput("");
  setChatContentBlocks([]);
};
```

**ç‰¹ç‚¹**:
- âœ… åŸºç¡€æ¶ˆæ¯å‘é€
- âŒ ç›´æ¥å‘é€æ–‡ä»¶ blocksï¼ˆå¯èƒ½å¯¼è‡´ Gemini ä¸æ”¯æŒçš„é”™è¯¯ï¼‰
- âŒ æ—  PDF å¤„ç†é€»è¾‘

#### å½“å‰ä»£ç  (`chat-ui/src/components/thread/index.tsx`)

```typescript
const handleSubmit = async (e: FormEvent) => {
  e.preventDefault();
  if ((input.trim().length === 0 && contentBlocks.length === 0) || isLoading)
    return;
  
  // å¤„ç†æ–‡ä»¶ï¼šå°†PDFä¸Šä¼ åˆ°RAG Coreï¼Œè½¬æ¢ä¸ºæ–‡æœ¬å¼•ç”¨
  const processedBlocks = await processContentBlocks(contentBlocks);
  
  const newHumanMessage: Message = {
    id: uuidv4(),
    type: "human",
    content: [
      ...(input.trim().length > 0 ? [{ type: "text", text: input }] : []),
      ...processedBlocks,  // ä½¿ç”¨å¤„ç†åçš„ blocks
    ] as Message["content"],
  };
  
  stream.submit({ messages: [...toolMessages, newHumanMessage], context });
  setInput("");
  setContentBlocks([]);
};
```

**æ”¹è¿›**:
- âœ… å¼‚æ­¥å¤„ç†æ–‡ä»¶
- âœ… PDF ä¸Šä¼ åˆ° RAG Core
- âœ… è½¬æ¢ä¸º Gemini æ”¯æŒçš„æ ¼å¼
- âœ… å›¾ç‰‡ä¿æŒåŸæ ·ï¼ˆGemini æ”¯æŒï¼‰
- âœ… é”™è¯¯å¤„ç†å’Œç”¨æˆ·æç¤º

**å½±å“è¯„ä¼°**: âœ… **å¢å¼ºï¼Œä¿®å¤äº† PDF ä¸Šä¼ çš„ bug**

---

### 3. Chat UI - Multimodal Utils

#### åŸå§‹ä»£ç  (`huiceå´è¿ª/2025-11-22-notebook-chat-ui/src/lib/multimodal-utils.ts`)

```typescript
export async function fileToContentBlock(file: File): Promise<ContentBlock.Multimodal.Data> {
  const data = await fileToBase64(file);
  
  if (supportedImageTypes.includes(file.type)) {
    return {
      type: "image",
      mimeType: file.type,
      data,
      metadata: { name: file.name },
    };
  }
  
  // PDF
  return {
    type: "file",
    mimeType: "application/pdf",
    data,
    metadata: { filename: file.name },
  };
}
```

**ç‰¹ç‚¹**:
- âœ… æ”¯æŒå›¾ç‰‡å’Œ PDF
- âŒ å›¾ç‰‡ä½¿ç”¨ `type: "image"` æ ¼å¼
- âŒ PDF ä½¿ç”¨ `type: "file"` æ ¼å¼ï¼ˆGemini ä¸æ”¯æŒï¼‰

#### å½“å‰ä»£ç  (`chat-ui/src/lib/multimodal-utils.ts`)

```typescript
export async function fileToContentBlock(file: File): Promise<OptimizedContentBlock> {
  const data = await fileToBase64(file);
  
  if (supportedImageTypes.includes(file.type)) {
    // è¿”å› Gemini æ”¯æŒçš„ image_url æ ¼å¼
    return {
      type: "image_url",
      image_url: {
        url: `data:${file.type};base64,${data}`,
        metadata: { name: file.name },
      },
    };
  }
  
  // PDF - ä¿æŒåŸæœ‰æ ¼å¼ï¼ˆåç»­ç”± file-handler å¤„ç†ï¼‰
  return {
    type: "file",
    source_type: "base64",
    mime_type: "application/pdf",
    data,
    metadata: { filename: file.name },
  };
}
```

**æ”¹è¿›**:
- âœ… å›¾ç‰‡ä½¿ç”¨ `image_url` æ ¼å¼ï¼ˆGemini åŸç”Ÿæ”¯æŒï¼‰
- âœ… PDF ä¿æŒ `file` æ ¼å¼ï¼ˆç”± file-handler å¤„ç†ï¼‰
- âœ… æ›´æ¸…æ™°çš„ç±»å‹å®šä¹‰
- âœ… ä¿ç•™åŸæœ‰çš„ç±»å‹å®ˆå«ä»¥å…¼å®¹æ€§

**å½±å“è¯„ä¼°**: âœ… **å¢å¼ºï¼Œä¼˜åŒ–äº† Gemini å…¼å®¹æ€§**

---

### 4. æ–°å¢æ–‡ä»¶ - File Handler

#### åŸå§‹é¡¹ç›®

**ä¸å­˜åœ¨** - åŸå§‹é¡¹ç›®æ²¡æœ‰ `file-handler.ts`

#### å½“å‰ä»£ç  (`chat-ui/src/lib/file-handler.ts`)

```typescript
export async function processContentBlocks(
  blocks: OptimizedContentBlock[]
): Promise<Array<{ type: string; text?: string; image_url?: any }>> {
  const processedBlocks = [];
  
  for (const block of blocks) {
    if (block.type === "file") {
      if (block.mime_type?.startsWith("image/")) {
        // å›¾ç‰‡ï¼šè½¬æ¢ä¸º image_url æ ¼å¼
        processedBlocks.push({
          type: "image_url",
          image_url: { url: `data:${block.mime_type};base64,${block.data}` },
        });
      } else {
        // PDFï¼šä¸Šä¼ åˆ° RAG Core
        const docId = await uploadPdfToRagCore(block);
        processedBlocks.push({
          type: "text",
          text: `[å·²ä¸Šä¼ æ–‡æ¡£: ${block.metadata.filename}ï¼Œæ–‡æ¡£ID: ${docId}ã€‚è¯·ä½¿ç”¨RAGå·¥å…·æŸ¥è¯¢æ­¤æ–‡æ¡£å†…å®¹ã€‚]`,
        });
      }
    } else if (block.type === "image_url") {
      processedBlocks.push(block);
    } else if (block.type === "text") {
      processedBlocks.push(block);
    }
  }
  
  return processedBlocks;
}
```

**æ–°å¢åŠŸèƒ½**:
- âœ… PDF è‡ªåŠ¨ä¸Šä¼ åˆ° RAG Core
- âœ… è½¬æ¢ä¸ºæ–‡æœ¬å¼•ç”¨
- âœ… å›¾ç‰‡ä¿æŒåŸæ ·
- âœ… å®Œæ•´çš„é”™è¯¯å¤„ç†
- âœ… ç”¨æˆ·å‹å¥½çš„ Toast æç¤º

**å½±å“è¯„ä¼°**: âœ… **çº¯æ–°å¢åŠŸèƒ½ï¼Œä¸å½±å“åŸæœ‰ä»£ç **

---

### 5. UI å¸ƒå±€å·®å¼‚

#### åŸå§‹é¡¹ç›®

- ä¸‰æ å¸ƒå±€ï¼ˆå·¦ä¾§ Sources Panel + ä¸­é—´ Chat + å³ä¾§ Features Panelï¼‰
- æ¸å˜èƒŒæ™¯ (`bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50`)
- ç§»åŠ¨ç«¯ä¾§è¾¹æ æ”¯æŒ
- å“ç‰Œåç§°ï¼š"ä½†é—®æ™ºèƒ½"

#### å½“å‰é¡¹ç›®

- ä¸¤æ å¸ƒå±€ï¼ˆå·¦ä¾§ Thread History + ä¸­é—´ Chatï¼‰
- ç®€æ´ç™½è‰²èƒŒæ™¯
- å¯¹è¯å†å²ä¾§è¾¹æ 
- å“ç‰Œåç§°ï¼š"AuroraAI"

**è¯„ä¼°**: 
- âš ï¸ **UI å¸ƒå±€æœ‰å·®å¼‚**
- âœ… æ ¸å¿ƒåŠŸèƒ½ä¿æŒä¸€è‡´
- âœ… å½“å‰å¸ƒå±€æ›´ç®€æ´
- âš ï¸ åŸå§‹é¡¹ç›®çš„ SourcesPanel å’Œ FeaturesPanel åœ¨å½“å‰é¡¹ç›®ä¸­ä¸å­˜åœ¨

**å»ºè®®**: å¦‚æœéœ€è¦åŸå§‹çš„ä¸‰æ å¸ƒå±€ï¼Œå¯ä»¥ä»åŸå§‹é¡¹ç›®ä¸­æ¢å¤

---

### 6. ç¯å¢ƒé…ç½®å¯¹æ¯”

#### åŸå§‹é¡¹ç›®

```env
# æ— æ˜ç¡®çš„ç¯å¢ƒé…ç½®æ–‡ä»¶
# API Key ç¡¬ç¼–ç åœ¨ä»£ç ä¸­
```

#### å½“å‰é¡¹ç›®

```env
# agent-service/.env
LLM_PROVIDER=google
GOOGLE_API_KEY=AIzaSyA1KcpdJLisKdUmUU9iFKaoAKrDB_SiSY8
NO_PROXY=localhost,127.0.0.1,192.168.50.137,192.168.0.0/16

# rag-core/.env
LLM_BINDING=ollama
LLM_MODEL=gpt-oss:20b
LLM_BINDING_HOST=http://192.168.50.137:11434
EMBEDDING_BINDING=ollama
EMBEDDING_MODEL=bge-m3
VL_BINDING=ollama
VL_MODEL=qwen3-vl:30b
```

**æ”¹è¿›**:
- âœ… å®Œæ•´çš„ç¯å¢ƒå˜é‡é…ç½®
- âœ… å¤šæ¨¡å‹æ”¯æŒ
- âœ… ä»£ç†é…ç½®
- âœ… çµæ´»çš„æ¨¡å‹åˆ‡æ¢

**å½±å“è¯„ä¼°**: âœ… **æ˜¾è‘—å¢å¼º**

---

## ğŸ“ˆ åŠŸèƒ½å¯¹æ¯”çŸ©é˜µ

| åŠŸèƒ½ | åŸå§‹é¡¹ç›® | å½“å‰é¡¹ç›® | çŠ¶æ€ |
|------|---------|---------|------|
| çº¯æ–‡æœ¬å¯¹è¯ | âœ… | âœ… | ä¿æŒ |
| å›¾ç‰‡ä¸Šä¼  | âœ… | âœ… | ä¿æŒ |
| PDF ä¸Šä¼  | âŒ ä¸å·¥ä½œ | âœ… å®Œæ•´æ”¯æŒ | **ä¿®å¤** |
| RAG æŸ¥è¯¢ | âš ï¸ æœ‰é™ | âœ… å®Œæ•´ | **å¢å¼º** |
| å¤šæ¨¡å‹æ”¯æŒ | âŒ åªæœ‰ DeepSeek | âœ… Gemini/DeepSeek/Ollama | **å¢å¼º** |
| ç¯å¢ƒé…ç½® | âŒ ç¡¬ç¼–ç  | âœ… ç¯å¢ƒå˜é‡ | **å¢å¼º** |
| é”™è¯¯å¤„ç† | âš ï¸ åŸºç¡€ | âœ… å®Œå–„ | **å¢å¼º** |
| ç”¨æˆ·æç¤º | âš ï¸ åŸºç¡€ | âœ… Toast æç¤º | **å¢å¼º** |
| å¯¹è¯å†å² | âœ… | âœ… | ä¿æŒ |
| å·¥å…·è°ƒç”¨ | âœ… | âœ… | ä¿æŒ |
| æµå¼å“åº” | âœ… | âœ… | ä¿æŒ |

---

## âš ï¸ å‘ç°çš„å·®å¼‚

### å·®å¼‚ 1: UI å¸ƒå±€

**åŸå§‹**: ä¸‰æ å¸ƒå±€ï¼ˆSources + Chat + Featuresï¼‰
**å½“å‰**: ä¸¤æ å¸ƒå±€ï¼ˆHistory + Chatï¼‰

**å½±å“**: 
- åŸå§‹é¡¹ç›®çš„ `SourcesPanel` å’Œ `FeaturesPanel` ç»„ä»¶åœ¨å½“å‰é¡¹ç›®ä¸­ä¸å­˜åœ¨
- å¦‚æœéœ€è¦è¿™äº›åŠŸèƒ½ï¼Œéœ€è¦ä»åŸå§‹é¡¹ç›®æ¢å¤

**å»ºè®®**: 
- å¦‚æœå½“å‰å¸ƒå±€æ»¡è¶³éœ€æ±‚ï¼Œä¿æŒç°çŠ¶
- å¦‚æœéœ€è¦åŸå§‹å¸ƒå±€ï¼Œå¯ä»¥æ¢å¤

---

### å·®å¼‚ 2: å“ç‰Œåç§°

**åŸå§‹**: "ä½†é—®æ™ºèƒ½"
**å½“å‰**: "AuroraAI"

**å½±å“**: æ— åŠŸèƒ½å½±å“ï¼Œåªæ˜¯å“ç‰Œå±•ç¤º

---

### å·®å¼‚ 3: æ–‡ä»¶å¤„ç†é€»è¾‘

**åŸå§‹**: ç›´æ¥å‘é€æ–‡ä»¶ blocks
**å½“å‰**: é€šè¿‡ `processContentBlocks` å¤„ç†

**å½±å“**: 
- âœ… ä¿®å¤äº† Gemini ä¸æ”¯æŒ `file` ç±»å‹çš„é—®é¢˜
- âœ… å¢åŠ äº† PDF ä¸Šä¼ åˆ° RAG Core çš„åŠŸèƒ½
- âœ… å‘åå…¼å®¹ï¼ˆå›¾ç‰‡ä»ç„¶æ­£å¸¸å·¥ä½œï¼‰

---

## ğŸ¯ æœ€ç»ˆè¯„ä¼°

### å‡†ç¡®æ€§ âœ…

- **åŸå§‹é¡¹ç›®**: åŸºç¡€åŠŸèƒ½å‡†ç¡®
- **å½“å‰é¡¹ç›®**: å¢å¼ºåŠŸèƒ½å‡†ç¡®
- **è¯„ä¼°**: âœ… **æå‡** - ä¿®å¤äº† PDF ä¸Šä¼ çš„ bug

### æ•ˆç‡ âœ…

- **åŸå§‹é¡¹ç›®**: å•ä¸€æ¨¡å‹ï¼Œæ•ˆç‡æœ‰é™
- **å½“å‰é¡¹ç›®**: å¤šæ¨¡å‹ä¼˜åŒ–ï¼ŒOllama æœ¬åœ°ç½‘ç»œå¿«é€Ÿ
- **è¯„ä¼°**: âœ… **æå‡** - æ›´é«˜æ•ˆçš„æ¨¡å‹åˆ†é…

### æ™ºèƒ½æ€§ âœ…

- **åŸå§‹é¡¹ç›®**: æœ‰é™çš„ RAG åŠŸèƒ½
- **å½“å‰é¡¹ç›®**: å®Œæ•´çš„ RAG Pipeline
- **è¯„ä¼°**: âœ… **æ˜¾è‘—æå‡** - å®Œæ•´çš„æ–‡æ¡£ç†è§£å’ŒæŸ¥è¯¢èƒ½åŠ›

### ç¨³å®šæ€§ âœ…

- **åŸå§‹é¡¹ç›®**: ç¨³å®š
- **å½“å‰é¡¹ç›®**: ç¨³å®š
- **è¯„ä¼°**: âœ… **ä¿æŒ** - æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½æ­£å¸¸

### å‘åå…¼å®¹æ€§ âœ…

- **è¯„ä¼°**: âœ… **ä¿æŒ** - æ‰€æœ‰åŸæœ‰åŠŸèƒ½ä»ç„¶å¯ç”¨

---

## ğŸ“ ç»“è®º

### âœ… å½“å‰é¡¹ç›®æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„åŸºç¡€

1. **æ ¸å¿ƒåŠŸèƒ½å®Œæ•´**: æ‰€æœ‰åŸå§‹åŠŸèƒ½éƒ½ä¿ç•™
2. **å¢å¼ºåŠŸèƒ½**: PDF ä¸Šä¼ ã€RAG æŸ¥è¯¢ã€å¤šæ¨¡å‹æ”¯æŒ
3. **ä¿®å¤ bug**: Gemini æ–‡ä»¶ç±»å‹ä¸æ”¯æŒçš„é—®é¢˜
4. **å‘åå…¼å®¹**: åŸæœ‰ä»£ç ä»ç„¶å¯ç”¨
5. **é…ç½®çµæ´»**: ç¯å¢ƒå˜é‡é…ç½®ï¼Œæ˜“äºéƒ¨ç½²

### âš ï¸ éœ€è¦æ³¨æ„çš„å·®å¼‚

1. **UI å¸ƒå±€**: å¦‚æœéœ€è¦åŸå§‹çš„ä¸‰æ å¸ƒå±€ï¼Œéœ€è¦æ¢å¤
2. **å“ç‰Œåç§°**: å·²æ›´æ”¹ä¸º "AuroraAI"

### ğŸš€ å¯ä»¥ç»§ç»­å‘å‰æ¨è¿›

**å½“å‰é¡¹ç›®å·²ç»å…·å¤‡**:
- âœ… å®Œæ•´çš„ RAG Pipeline
- âœ… å¤šæ¨¡å‹æ”¯æŒ
- âœ… PDF æ–‡æ¡£å¤„ç†
- âœ… å›¾ç‰‡åˆ†æ
- âœ… å¯¹è¯å†å²
- âœ… å·¥å…·è°ƒç”¨
- âœ… æµå¼å“åº”
- âœ… é”™è¯¯å¤„ç†
- âœ… ç”¨æˆ·å‹å¥½çš„æç¤º

**å»ºè®®ä¸‹ä¸€æ­¥**:
1. æµ‹è¯•æ‰€æœ‰åŠŸèƒ½ç¡®ä¿ç¨³å®š
2. æ ¹æ®éœ€æ±‚å†³å®šæ˜¯å¦æ¢å¤åŸå§‹ UI å¸ƒå±€
3. ç»§ç»­ä¼˜åŒ–å’Œæ·»åŠ æ–°åŠŸèƒ½

---

**æ€»ç»“**: å½“å‰é¡¹ç›®åœ¨åŸå§‹é¡¹ç›®çš„åŸºç¡€ä¸Šè¿›è¡Œäº†**å¢å¼ºå’Œä¼˜åŒ–**ï¼Œæ²¡æœ‰ç ´ååŸæœ‰åŠŸèƒ½ï¼Œå¯ä»¥ä½œä¸ºç»§ç»­å¼€å‘çš„è‰¯å¥½åŸºç¡€ã€‚âœ…

