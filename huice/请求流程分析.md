# RAG æŸ¥è¯¢è¯·æ±‚æµç¨‹åˆ†æ

**æŸ¥è¯¢**: "æ°´åº”è¯¥æ§åˆ¶åœ¨å¤šå°‘åº¦å‘¢"  
**æ–‡æ¡£**: aerobie-aeropress-user-manual.pdf  
**å›ç­”**: "æ ¹æ®æ–‡æ¡£ï¼Œå»ºè®®çš„æ°´æ¸©æ˜¯ 175Â°F (80Â°C)"

---

## ğŸ“Š å®Œæ•´è¯·æ±‚æµç¨‹åˆ†è§£

### é˜¶æ®µ 1: ç”¨æˆ·æé—®ï¼ˆChat UIï¼‰

**ç”¨æˆ·è¾“å…¥**: "æ°´åº”è¯¥æ§åˆ¶åœ¨å¤šå°‘åº¦å‘¢"

**Chat UI å¤„ç†**:
```
ç”¨æˆ·è¾“å…¥æ–‡æœ¬
    â†“
contentBlocks = []ï¼ˆæ²¡æœ‰æ–‡ä»¶ä¸Šä¼ ï¼‰
    â†“
processContentBlocks([]) â†’ è¿”å› []
    â†“
æ„å»ºæ¶ˆæ¯:
{
  type: "human",
  content: [
    { type: "text", text: "æ°´åº”è¯¥æ§åˆ¶åœ¨å¤šå°‘åº¦å‘¢" }
  ]
}
    â†“
å‘é€åˆ° Agent Service (http://localhost:2025)
```

**ä½¿ç”¨çš„æ¨¡å‹**: âŒ æ— ï¼ˆçº¯å‰ç«¯å¤„ç†ï¼‰

---

### é˜¶æ®µ 2: Agent ç†è§£æ„å›¾ï¼ˆAgent Serviceï¼‰

**Agent Service æ¥æ”¶æ¶ˆæ¯**:
```
POST http://localhost:2025/threads/{thread_id}/runs/stream
Body: {
  "messages": [
    {
      "type": "human",
      "content": [
        { "type": "text", "text": "æ°´åº”è¯¥æ§åˆ¶åœ¨å¤šå°‘åº¦å‘¢" }
      ]
    }
  ]
}
```

**Agent å¤„ç†**:
```
LangGraph Agent å¯åŠ¨
    â†“
è°ƒç”¨ LLM ç†è§£ç”¨æˆ·æ„å›¾
    â†“
åˆ¤æ–­ï¼šè¿™æ˜¯ä¸€ä¸ªå…³äºæ–‡æ¡£å†…å®¹çš„é—®é¢˜
    â†“
å†³å®šï¼šéœ€è¦è°ƒç”¨ MCP query_knowledge å·¥å…·
```

**ä½¿ç”¨çš„æ¨¡å‹**: âœ… **Gemini 2.0 Flash**
- **ä½ç½®**: Agent Service
- **é…ç½®**: `agent-service/.env`
  ```env
  LLM_PROVIDER=google
  GOOGLE_API_KEY=AIzaSyA1KcpdJLisKdUmUU9iFKaoAKrDB_SiSY8
  GOOGLE_MODEL=gemini-2.0-flash
  ```
- **è¯·æ±‚**: 
  ```
  POST https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent
  ```
- **Prompt**:
  ```
  System: You are a helpful AI assistant with access to RAG tools...
  
  User: æ°´åº”è¯¥æ§åˆ¶åœ¨å¤šå°‘åº¦å‘¢
  
  Available tools:
  - query_knowledge: Query the knowledge base
  - ...
  
  What should you do?
  ```
- **Response**:
  ```json
  {
    "tool_calls": [
      {
        "name": "query_knowledge",
        "arguments": {
          "query_text": "æ°´æ¸© æ¸©åº¦ æ§åˆ¶",
          "mode": "hybrid",
          "top_k": 10
        }
      }
    ]
  }
  ```

**æˆæœ¬**: Gemini API è°ƒç”¨ï¼ˆå…è´¹é¢åº¦å†…ï¼‰

---

### é˜¶æ®µ 3: è°ƒç”¨ MCP å·¥å…·ï¼ˆAgent â†’ MCP Serverï¼‰

**Agent è°ƒç”¨ MCP**:
```
Agent å†³å®šè°ƒç”¨ query_knowledge å·¥å…·
    â†“
å‘é€è¯·æ±‚åˆ° MCP Server
POST http://localhost:8001/sse
```

**MCP Server å¤„ç†**:
```
æ¥æ”¶å·¥å…·è°ƒç”¨è¯·æ±‚
    â†“
è§£æå‚æ•°: query_text="æ°´æ¸© æ¸©åº¦ æ§åˆ¶"
    â†“
è°ƒç”¨ RAG Core API
```

**ä½¿ç”¨çš„æ¨¡å‹**: âŒ æ— ï¼ˆåªæ˜¯è½¬å‘è¯·æ±‚ï¼‰

---

### é˜¶æ®µ 4: RAG æ£€ç´¢ï¼ˆMCP Server â†’ RAG Coreï¼‰

**MCP è°ƒç”¨ RAG Core**:
```
POST http://localhost:9621/query
Body: {
  "query": "æ°´æ¸© æ¸©åº¦ æ§åˆ¶",
  "mode": "hybrid",
  "top_k": 10
}
```

**RAG Core å¤„ç†**:

#### 4.1 æŸ¥è¯¢å‘é‡åŒ–

```
æ¥æ”¶æŸ¥è¯¢æ–‡æœ¬: "æ°´æ¸© æ¸©åº¦ æ§åˆ¶"
    â†“
è°ƒç”¨ Embedding æ¨¡å‹å‘é‡åŒ–
```

**ä½¿ç”¨çš„æ¨¡å‹**: âœ… **Ollama bge-m3**
- **ä½ç½®**: è¿œç¨‹ Ollama æœåŠ¡å™¨
- **åœ°å€**: `http://192.168.50.137:11434`
- **é…ç½®**: `rag-core/.env`
  ```env
  EMBEDDING_BINDING=ollama
  EMBEDDING_MODEL=bge-m3
  EMBEDDING_BINDING_HOST=http://192.168.50.137:11434
  ```
- **è¯·æ±‚**:
  ```
  POST http://192.168.50.137:11434/api/embeddings
  Body: {
    "model": "bge-m3",
    "prompt": "æ°´æ¸© æ¸©åº¦ æ§åˆ¶"
  }
  ```
- **Response**:
  ```json
  {
    "embedding": [0.123, -0.456, 0.789, ...] // 1024 ç»´å‘é‡
  }
  ```

**æˆæœ¬**: å…è´¹ï¼ˆæœ¬åœ° Ollamaï¼‰

---

#### 4.2 å‘é‡æ£€ç´¢

```
æŸ¥è¯¢å‘é‡: [0.123, -0.456, 0.789, ...]
    â†“
åœ¨å‘é‡æ•°æ®åº“ä¸­æœç´¢ç›¸ä¼¼æ–‡æ¡£ç‰‡æ®µ
    â†“
è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦
    â†“
è¿”å› Top-K ç›¸å…³ç‰‡æ®µ
```

**ä½¿ç”¨çš„æ¨¡å‹**: âŒ æ— ï¼ˆçº¯å‘é‡è®¡ç®—ï¼‰

**æ£€ç´¢ç»“æœ**:
```json
[
  {
    "chunk_id": "chunk_001",
    "content": "...recommended water temperature is 175Â°F (80Â°C)...",
    "score": 0.89
  },
  {
    "chunk_id": "chunk_002",
    "content": "...water should be between 165Â°F and 185Â°F...",
    "score": 0.85
  },
  ...
]
```

---

#### 4.3 ç”Ÿæˆå›ç­”ï¼ˆå¯é€‰ï¼‰

**å¦‚æœ RAG Core é…ç½®äº†ç”Ÿæˆå›ç­”**:
```
æ£€ç´¢åˆ°çš„æ–‡æ¡£ç‰‡æ®µ
    â†“
è°ƒç”¨ LLM ç”Ÿæˆå›ç­”
```

**ä½¿ç”¨çš„æ¨¡å‹**: âœ… **Ollama gpt-oss:20b**
- **ä½ç½®**: è¿œç¨‹ Ollama æœåŠ¡å™¨
- **åœ°å€**: `http://192.168.50.137:11434`
- **é…ç½®**: `rag-core/.env`
  ```env
  LLM_BINDING=ollama
  LLM_MODEL=gpt-oss:20b
  LLM_BINDING_HOST=http://192.168.50.137:11434
  ```
- **è¯·æ±‚**:
  ```
  POST http://192.168.50.137:11434/api/generate
  Body: {
    "model": "gpt-oss:20b",
    "prompt": "Based on the following context, answer the question...\n\nContext: ...recommended water temperature is 175Â°F (80Â°C)...\n\nQuestion: æ°´æ¸© æ¸©åº¦ æ§åˆ¶\n\nAnswer:"
  }
  ```

**æ³¨æ„**: åœ¨å½“å‰é…ç½®ä¸­ï¼ŒRAG Core å¯èƒ½åªè¿”å›æ£€ç´¢ç»“æœï¼Œä¸ç”Ÿæˆå›ç­”ã€‚

**æˆæœ¬**: å…è´¹ï¼ˆæœ¬åœ° Ollamaï¼‰

---

### é˜¶æ®µ 5: Agent ç”Ÿæˆæœ€ç»ˆå›ç­”ï¼ˆAgent Serviceï¼‰

**Agent æ¥æ”¶ MCP è¿”å›çš„ç»“æœ**:
```json
{
  "tool_result": {
    "chunks": [
      {
        "content": "...recommended water temperature is 175Â°F (80Â°C)...",
        "score": 0.89
      }
    ]
  }
}
```

**Agent ç”Ÿæˆæœ€ç»ˆå›ç­”**:
```
æ¥æ”¶æ£€ç´¢ç»“æœ
    â†“
è°ƒç”¨ LLM ç”Ÿæˆç”¨æˆ·å‹å¥½çš„å›ç­”
```

**ä½¿ç”¨çš„æ¨¡å‹**: âœ… **Gemini 2.0 Flash**
- **ä½ç½®**: Agent Service
- **è¯·æ±‚**:
  ```
  POST https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent
  ```
- **Prompt**:
  ```
  System: You are a helpful AI assistant...
  
  User: æ°´åº”è¯¥æ§åˆ¶åœ¨å¤šå°‘åº¦å‘¢
  
  Tool result from query_knowledge:
  - Chunk 1: ...recommended water temperature is 175Â°F (80Â°C)...
  - Chunk 2: ...water should be between 165Â°F and 185Â°F...
  
  Generate a helpful answer in Chinese.
  ```
- **Response**:
  ```
  æ ¹æ®æ–‡æ¡£ "aerobie-aeropress-user-manual.pdf"ï¼Œå»ºè®®çš„æ°´æ¸©æ˜¯ 175Â°F (80Â°C)ã€‚
  ```

**æˆæœ¬**: Gemini API è°ƒç”¨ï¼ˆå…è´¹é¢åº¦å†…ï¼‰

---

### é˜¶æ®µ 6: è¿”å›ç»™ç”¨æˆ·ï¼ˆAgent â†’ Chat UIï¼‰

**Agent æµå¼è¿”å›**:
```
Agent ç”Ÿæˆå›ç­”
    â†“
é€šè¿‡ SSE (Server-Sent Events) æµå¼è¿”å›
    â†“
Chat UI é€å­—æ˜¾ç¤º
```

**ç”¨æˆ·çœ‹åˆ°**:
```
æ ¹æ®æ–‡æ¡£ "aerobie-aeropress-user-manual.pdf"ï¼Œå»ºè®®çš„æ°´æ¸©æ˜¯ 175Â°F (80Â°C)ã€‚
```

---

## ğŸ“Š æ¨¡å‹ä½¿ç”¨æ€»ç»“

### Gemini 2.0 Flashï¼ˆGoogle APIï¼‰

**ä½¿ç”¨æ¬¡æ•°**: 2 æ¬¡

1. **ç¬¬ä¸€æ¬¡**: ç†è§£ç”¨æˆ·æ„å›¾ï¼Œå†³å®šè°ƒç”¨å·¥å…·
   - è¾“å…¥: "æ°´åº”è¯¥æ§åˆ¶åœ¨å¤šå°‘åº¦å‘¢"
   - è¾“å‡º: å†³å®šè°ƒç”¨ `query_knowledge` å·¥å…·

2. **ç¬¬äºŒæ¬¡**: ç”Ÿæˆæœ€ç»ˆå›ç­”
   - è¾“å…¥: ç”¨æˆ·é—®é¢˜ + æ£€ç´¢ç»“æœ
   - è¾“å‡º: "æ ¹æ®æ–‡æ¡£ï¼Œå»ºè®®çš„æ°´æ¸©æ˜¯ 175Â°F (80Â°C)"

**æ€» Token æ¶ˆè€—**: çº¦ 500-1000 tokens
**æˆæœ¬**: $0ï¼ˆå…è´¹é¢åº¦å†…ï¼‰

---

### Ollama bge-m3ï¼ˆ192.168.50.137:11434ï¼‰

**ä½¿ç”¨æ¬¡æ•°**: 1 æ¬¡

1. **æŸ¥è¯¢å‘é‡åŒ–**
   - è¾“å…¥: "æ°´æ¸© æ¸©åº¦ æ§åˆ¶"
   - è¾“å‡º: 1024 ç»´å‘é‡

**æˆæœ¬**: $0ï¼ˆå®Œå…¨å…è´¹ï¼‰

---

### Ollama gpt-oss:20bï¼ˆ192.168.50.137:11434ï¼‰

**ä½¿ç”¨æ¬¡æ•°**: 0 æ¬¡ï¼ˆå¯èƒ½ï¼‰

- å½“å‰é…ç½®ä¸­ï¼ŒRAG Core å¯èƒ½åªè¿”å›æ£€ç´¢ç»“æœ
- ä¸åœ¨ RAG Core å±‚é¢ç”Ÿæˆå›ç­”
- ç”± Agent çš„ Gemini ç”Ÿæˆæœ€ç»ˆå›ç­”

**æˆæœ¬**: $0ï¼ˆå®Œå…¨å…è´¹ï¼‰

---

## ğŸ¯ è¯·æ±‚è·¯å¾„å›¾

```
ç”¨æˆ·æé—®: "æ°´åº”è¯¥æ§åˆ¶åœ¨å¤šå°‘åº¦å‘¢"
    â†“
Chat UI (localhost:3000)
    â†“
Agent Service (localhost:2025)
    â†“ [Gemini 1] ç†è§£æ„å›¾
    â†“
å†³å®šè°ƒç”¨ query_knowledge
    â†“
MCP Server (localhost:8001)
    â†“
RAG Core (localhost:9621)
    â†“ [Ollama bge-m3] å‘é‡åŒ–æŸ¥è¯¢
    â†“
å‘é‡æ•°æ®åº“æ£€ç´¢
    â†“
è¿”å›ç›¸å…³æ–‡æ¡£ç‰‡æ®µ
    â†“
MCP Server
    â†“
Agent Service
    â†“ [Gemini 2] ç”Ÿæˆå›ç­”
    â†“
Chat UI
    â†“
ç”¨æˆ·çœ‹åˆ°: "æ ¹æ®æ–‡æ¡£ï¼Œå»ºè®®çš„æ°´æ¸©æ˜¯ 175Â°F (80Â°C)"
```

---

## ğŸ’° æˆæœ¬åˆ†æ

### å•æ¬¡æŸ¥è¯¢æˆæœ¬

| ç»„ä»¶ | æ¨¡å‹ | ä½¿ç”¨æ¬¡æ•° | Token æ¶ˆè€— | æˆæœ¬ |
|------|------|---------|-----------|------|
| Agent - æ„å›¾ç†è§£ | Gemini 2.0 Flash | 1 | ~300 tokens | $0 |
| RAG - å‘é‡åŒ– | Ollama bge-m3 | 1 | N/A | $0 |
| Agent - ç”Ÿæˆå›ç­” | Gemini 2.0 Flash | 1 | ~500 tokens | $0 |
| **æ€»è®¡** | - | - | ~800 tokens | **$0** |

### æ¯æ—¥æˆæœ¬ï¼ˆ100 æ¬¡æŸ¥è¯¢ï¼‰

- Gemini: 80,000 tokens â‰ˆ $0ï¼ˆå…è´¹é¢åº¦ï¼š1,500,000 tokens/å¤©ï¼‰
- Ollama: å®Œå…¨å…è´¹

**æ€»æˆæœ¬**: $0/å¤©

---

## ğŸ”§ ä¼˜åŒ–å»ºè®®

### ä¼˜åŒ– 1: å‡å°‘ Gemini è°ƒç”¨

**å½“å‰**: æ¯æ¬¡æŸ¥è¯¢è°ƒç”¨ Gemini 2 æ¬¡
**ä¼˜åŒ–**: å¯ä»¥è®© RAG Core ç›´æ¥ç”Ÿæˆå›ç­”ï¼Œå‡å°‘åˆ° 1 æ¬¡

**ä¿®æ”¹**: `rag-core/.env`
```env
# å¯ç”¨ RAG Core ç”Ÿæˆå›ç­”
ENABLE_RAG_ANSWER_GENERATION=true
```

**æ•ˆæœ**: 
- Gemini è°ƒç”¨: 2 æ¬¡ â†’ 1 æ¬¡
- æˆæœ¬é™ä½: 50%

---

### ä¼˜åŒ– 2: ä½¿ç”¨æœ¬åœ°æ¨¡å‹ç”Ÿæˆå›ç­”

**å½“å‰**: Agent ä½¿ç”¨ Gemini ç”Ÿæˆå›ç­”
**ä¼˜åŒ–**: ä½¿ç”¨ Ollama gpt-oss:20b ç”Ÿæˆå›ç­”

**ä¿®æ”¹**: `agent-service/.env`
```env
LLM_PROVIDER=ollama
OLLAMA_BASE_URL=http://192.168.50.137:11434
OLLAMA_MODEL=gpt-oss:20b
```

**æ•ˆæœ**:
- Gemini è°ƒç”¨: 2 æ¬¡ â†’ 0 æ¬¡
- æˆæœ¬: $0 â†’ $0ï¼ˆå·²ç»æ˜¯å…è´¹ï¼‰
- é€Ÿåº¦: å¯èƒ½æ›´å¿«ï¼ˆæœ¬åœ°ç½‘ç»œï¼‰

---

### ä¼˜åŒ– 3: ç¼“å­˜æŸ¥è¯¢ç»“æœ

**å®ç°**: ç¼“å­˜å¸¸è§é—®é¢˜çš„æ£€ç´¢ç»“æœ

**æ•ˆæœ**:
- å‡å°‘å‘é‡æ£€ç´¢æ¬¡æ•°
- å‡å°‘ LLM è°ƒç”¨æ¬¡æ•°
- å“åº”é€Ÿåº¦æ›´å¿«

---

## ğŸ“ æ€»ç»“

### å½“å‰æ¶æ„çš„ä¼˜åŠ¿

1. **æˆæœ¬æä½**: å®Œå…¨åœ¨å…è´¹é¢åº¦å†…
2. **æ€§èƒ½ä¼˜ç§€**: Ollama æœ¬åœ°ç½‘ç»œå¿«é€Ÿ
3. **è´¨é‡é«˜**: Gemini ç†è§£å’Œç”Ÿæˆèƒ½åŠ›å¼º

### è¯·æ±‚åˆ†é…

- **Gemini**: ç†è§£æ„å›¾ + ç”Ÿæˆå›ç­”ï¼ˆ2 æ¬¡ï¼‰
- **Ollama**: å‘é‡åŒ–æŸ¥è¯¢ï¼ˆ1 æ¬¡ï¼‰
- **å‘é‡æ•°æ®åº“**: æ£€ç´¢ï¼ˆçº¯è®¡ç®—ï¼‰

### æˆæœ¬

- **å•æ¬¡æŸ¥è¯¢**: $0
- **æ¯æ—¥ 100 æ¬¡**: $0
- **æ¯æœˆ 3000 æ¬¡**: $0

**è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä½ çš„æ¶æ„è®¾è®¡éå¸¸ä¼˜ç§€ï¼** ğŸ‰

