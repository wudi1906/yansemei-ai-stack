# æœ€ç»ˆé—®é¢˜åˆ†æžä¸Žè§£å†³

**æ—¥æœŸ**: 2025-12-05  
**çŠ¶æ€**: âœ… å·²å®Œå…¨ä¿®å¤

---

## ðŸŽ¯ ä½ çš„è§‚å¯Ÿå®Œå…¨æ­£ç¡®ï¼

ä½ è¯´ï¼š
> "æ•ˆæžœä¸Žæˆ‘é¢„æœŸçš„ä¸åŒ...æˆ‘è®°å¾—ä¹‹å‰è¿™ä¸ªç³»ç»Ÿå¯ä»¥ä»”ç»†åˆ†æžpdfä¸­çš„æ‰€æœ‰å†…å®¹ï¼Œç„¶åŽæ ¹æ®è¿™äº›å†…å®¹æ¥ç›´æŽ¥æ˜¾ç¤ºæˆ‘é—®é¢˜çš„ç­”æ¡ˆæ‰å¯¹"

**ä½ æ˜¯å¯¹çš„ï¼** ç³»ç»Ÿç¡®å®žåº”è¯¥è¿™æ ·å·¥ä½œã€‚

---

## ðŸ” çœŸæ­£çš„é—®é¢˜æ ¹æº

### é”™è¯¯ä¿¡æ¯åˆ†æž

ä»Žä½ çš„æˆªå›¾çœ‹åˆ°ï¼š
```
Unrecognized message part type: file. 
Only text, image_url, and media types are supported.
```

**è¿™è¯´æ˜Ž**ï¼š
1. PDF æ–‡ä»¶ä»¥ `type: "file"` çš„æ ¼å¼å‘é€ç»™äº† Gemini
2. Gemini **ä¸æ”¯æŒ** `file` ç±»åž‹
3. æ–‡ä»¶å¤„ç†å™¨ `processContentBlocks()` **æ ¹æœ¬æ²¡æœ‰è¢«è°ƒç”¨**ï¼

---

### ä»£ç é—®é¢˜å®šä½

#### é—®é¢˜ 1: `processContentBlocks` æ²¡æœ‰è¢«è°ƒç”¨ï¼ˆä¸¥é‡ï¼‰

**ä½ç½®**: `chat-ui/src/components/thread/index.tsx`

**åŽŸä»£ç ** (é”™è¯¯):
```typescript
const handleSubmit = (e: FormEvent) => {  // âŒ ä¸æ˜¯ async
  // ...
  const newHumanMessage: Message = {
    content: [
      ...(input.trim().length > 0 ? [{ type: "text", text: input }] : []),
      ...contentBlocks,  // âŒ ç›´æŽ¥ä½¿ç”¨åŽŸå§‹ contentBlocks
    ]
  };
  // ...
}
```

**é—®é¢˜**ï¼š
- `contentBlocks` åŒ…å« `type: "file"` çš„å¯¹è±¡
- ç›´æŽ¥å‘é€ç»™ Agent/Gemini
- Gemini ä¸æ”¯æŒ `file` ç±»åž‹ â†’ æŠ¥é”™

**ä¿®å¤åŽ** (æ­£ç¡®):
```typescript
const handleSubmit = async (e: FormEvent) => {  // âœ… async
  // ...
  // âœ… è°ƒç”¨ processContentBlocks å¤„ç†æ–‡ä»¶
  const processedBlocks = await processContentBlocks(contentBlocks);
  
  const newHumanMessage: Message = {
    content: [
      ...(input.trim().length > 0 ? [{ type: "text", text: input }] : []),
      ...processedBlocks,  // âœ… ä½¿ç”¨å¤„ç†åŽçš„ blocks
    ]
  };
  // ...
}
```

---

#### é—®é¢˜ 2: `processContentBlocks` é€»è¾‘ä¸å®Œæ•´

**åŽŸä»£ç ** (ä¸å®Œæ•´):
```typescript
export async function processContentBlocks(blocks) {
  const processedBlocks = [];
  
  for (const block of blocks) {
    if (block.type === "file" && block.mime_type === "application/pdf") {
      // âœ… å¤„ç† PDF
      const docId = await uploadPdfToRagCore(block);
      processedBlocks.push({ type: "text", text: `[å·²ä¸Šä¼ æ–‡æ¡£: ...]` });
    } else if (block.type === "image_url") {
      // âœ… å¤„ç† image_url
      processedBlocks.push(block);
    }
    // âŒ æ²¡æœ‰å¤„ç†å…¶ä»–æƒ…å†µï¼
  }
  
  return processedBlocks;
}
```

**é—®é¢˜**ï¼š
- åªå¤„ç†äº† `type: "file" && mime_type: "application/pdf"`
- æ²¡æœ‰å¤„ç† `type: "file" && mime_type: "image/*"`
- æ²¡æœ‰å¤„ç† `type: "text"`
- å…¶ä»–ç±»åž‹è¢«å¿½ç•¥

**ä¿®å¤åŽ** (å®Œæ•´):
```typescript
export async function processContentBlocks(blocks) {
  const processedBlocks = [];
  
  for (const block of blocks) {
    if (block.type === "file") {
      // æ£€æŸ¥æ˜¯å¦æ˜¯å›¾ç‰‡
      if (block.mime_type?.startsWith("image/")) {
        // âœ… å›¾ç‰‡ï¼šè½¬æ¢ä¸º image_url æ ¼å¼
        processedBlocks.push({
          type: "image_url",
          image_url: {
            url: `data:${block.mime_type};base64,${block.data}`,
          },
        });
      } else {
        // âœ… PDF/æ–‡æ¡£ï¼šä¸Šä¼ åˆ° RAG Core
        const docId = await uploadPdfToRagCore(block);
        processedBlocks.push({
          type: "text",
          text: `[å·²ä¸Šä¼ æ–‡æ¡£: ${block.metadata.filename}ï¼Œæ–‡æ¡£ID: ${docId}ã€‚è¯·ä½¿ç”¨RAGå·¥å…·æŸ¥è¯¢æ­¤æ–‡æ¡£å†…å®¹ã€‚]`,
        });
      }
    } else if (block.type === "image_url") {
      // âœ… å·²ç»æ˜¯ image_urlï¼Œä¿æŒåŽŸæ ·
      processedBlocks.push(block);
    } else if (block.type === "text") {
      // âœ… æ–‡æœ¬ï¼Œä¿æŒåŽŸæ ·
      processedBlocks.push(block);
    }
  }
  
  return processedBlocks;
}
```

---

## âœ… å®Œæ•´çš„ PDF å¤„ç†æµç¨‹

### æ­£ç¡®çš„æµç¨‹ï¼ˆä¿®å¤åŽï¼‰

```
ç”¨æˆ·åœ¨ Chat UI ä¸Šä¼  PDF
         â†“
useFileUpload hook è¯»å–æ–‡ä»¶
         â†“
contentBlocks = [{
  type: "file",
  mime_type: "application/pdf",
  data: "base64...",
  metadata: { filename: "xxx.pdf" }
}]
         â†“
ç”¨æˆ·ç‚¹å‡»"å‘é€"
         â†“
handleSubmit() è°ƒç”¨
         â†“
await processContentBlocks(contentBlocks)
         â†“
æ£€æµ‹åˆ° type: "file" && mime_type: "application/pdf"
         â†“
è°ƒç”¨ uploadPdfToRagCore()
         â†“
POST http://localhost:9621/documents/upload
         â†“
RAG Core åŽå°å¤„ç†:
  1. Docling è§£æž PDF
  2. æå–æ–‡æœ¬ã€å›¾ç‰‡ã€è¡¨æ ¼
  3. Ollama qwen3-vl åˆ†æžå›¾ç‰‡/è¡¨æ ¼
  4. æ–‡æœ¬åˆ†å—
  5. Ollama bge-m3 å‘é‡åŒ–
  6. å­˜å‚¨åˆ°å‘é‡æ•°æ®åº“
         â†“
è¿”å›ž track_id
         â†“
processContentBlocks è¿”å›ž:
[{
  type: "text",
  text: "[å·²ä¸Šä¼ æ–‡æ¡£: xxx.pdfï¼Œæ–‡æ¡£ID: upload_xxxã€‚è¯·ä½¿ç”¨RAGå·¥å…·æŸ¥è¯¢æ­¤æ–‡æ¡£å†…å®¹ã€‚]"
}]
         â†“
å‘é€ç»™ Agent Service
         â†“
Agent (Gemini) æ”¶åˆ°æ–‡æœ¬æ¶ˆæ¯
         â†“
ç†è§£ç”¨æˆ·æ„å›¾ï¼š"æŸ¥è¯¢æ–‡æ¡£å†…å®¹"
         â†“
å†³å®šè°ƒç”¨ MCP query_knowledge å·¥å…·
         â†“
MCP Server æŸ¥è¯¢ RAG Core
         â†“
è¿”å›žç›¸å…³æ–‡æ¡£ç‰‡æ®µï¼ˆåŒ…å«æ¸©åº¦ä¿¡æ¯ï¼‰
         â†“
Agent ç”Ÿæˆå›žç­”ï¼š
"æ ¹æ® AeroPress ç”¨æˆ·æ‰‹å†Œï¼ŒæŽ¨èçš„å·¥ä½œæ¸©åº¦æ˜¯ 175Â°F (çº¦ 80Â°C)..."
         â†“
è¿”å›žç»™ç”¨æˆ·
```

---

## ðŸ“Š ä»£ç ä¿®æ”¹æ€»ç»“

### ä¿®æ”¹ 1: `chat-ui/src/components/thread/index.tsx`

**æ”¹åŠ¨**:
1. `handleSubmit` æ”¹ä¸º `async`
2. è°ƒç”¨ `await processContentBlocks(contentBlocks)`
3. ä½¿ç”¨å¤„ç†åŽçš„ `processedBlocks`

**å½±å“**: âœ… æ ¸å¿ƒä¿®å¤ï¼Œç¡®ä¿æ–‡ä»¶è¢«æ­£ç¡®å¤„ç†

---

### ä¿®æ”¹ 2: `chat-ui/src/lib/file-handler.ts`

**æ”¹åŠ¨**:
1. å®Œå–„ `processContentBlocks` é€»è¾‘
2. å¤„ç†æ‰€æœ‰æ–‡ä»¶ç±»åž‹ï¼ˆå›¾ç‰‡ã€PDFã€æ–‡æ¡£ï¼‰
3. å¤„ç†æ‰€æœ‰ block ç±»åž‹ï¼ˆfileã€image_urlã€textï¼‰

**å½±å“**: âœ… ç¡®ä¿æ‰€æœ‰æƒ…å†µéƒ½è¢«æ­£ç¡®å¤„ç†

---

### ä¿®æ”¹ 3: `rag-core/.env`

**æ”¹åŠ¨**:
1. Vision ä»Ž `qwen` æ”¹ä¸º `ollama`
2. ä½¿ç”¨ `qwen3-vl:30b` æ¨¡åž‹

**å½±å“**: âœ… ä¿®å¤ Vision æ¨¡åž‹ä¸æ”¯æŒçš„é—®é¢˜

---

### ä¿®æ”¹ 4: å‡çº§ `protobuf`

**æ”¹åŠ¨**:
```bash
pip install "protobuf>=6.32.1,<7.0.0"
```

**å½±å“**: âœ… ä¿®å¤ Agent Service å¯åŠ¨å¤±è´¥

---

## ðŸŽ¯ çŽ°åœ¨å¯ä»¥æµ‹è¯•äº†å—ï¼Ÿ

### âœ… æ˜¯çš„ï¼æ‰€æœ‰ä»£ç å·²ç»æ˜¯æœ€å®Œå–„çš„äº†

**æ£€æŸ¥æ¸…å•**:

1. âœ… **protobuf å·²å‡çº§** - Agent Service å¯ä»¥å¯åŠ¨
2. âœ… **Vision é…ç½®æ­£ç¡®** - ä½¿ç”¨ Ollama qwen3-vl:30b
3. âœ… **file-handler.ts å®Œæ•´** - å¤„ç†æ‰€æœ‰æ–‡ä»¶ç±»åž‹
4. âœ… **thread/index.tsx æ­£ç¡®è°ƒç”¨** - processContentBlocks è¢«è°ƒç”¨
5. âœ… **NO_PROXY é…ç½®æ­£ç¡®** - Ollama è¿žæŽ¥ä¸èµ°ä»£ç†
6. âœ… **æ‰€æœ‰æœåŠ¡é…ç½®ä¸€è‡´** - RAG Core, MCP Server, Agent Service

---

## ðŸš€ ç«‹å³æµ‹è¯•æ­¥éª¤

### Step 1: é‡å¯ Chat UIï¼ˆå¿…é¡»ï¼ï¼‰

```bash
# åªéœ€è¦é‡å¯ Chat UIï¼ˆä»£ç å·²ä¿®æ”¹ï¼‰
pkill -f "next-server"

# ç­‰å¾… 2 ç§’
sleep 2

# é‡æ–°å¯åŠ¨ Chat UI
cd chat-ui
npm run dev &
cd ..
```

**ä¸ºä»€ä¹ˆåªé‡å¯ Chat UIï¼Ÿ**
- åªæœ‰ Chat UI çš„ä»£ç è¢«ä¿®æ”¹äº†
- å…¶ä»–æœåŠ¡ï¼ˆRAG Core, MCP, Agentï¼‰å·²ç»åœ¨è¿è¡Œ
- èŠ‚çœæ—¶é—´

---

### Step 2: ç­‰å¾… Chat UI å¯åŠ¨ï¼ˆ10ç§’ï¼‰

```bash
sleep 10
```

---

### Step 3: æµ‹è¯• PDF ä¸Šä¼ å’ŒæŸ¥è¯¢

**è®¿é—® Chat UI**:
```
http://localhost:3000
```

**æ“ä½œ**:
1. ç‚¹å‡» "ä¸Šä¼ PDFæˆ–å›¾ç‰‡" æŒ‰é’®
2. é€‰æ‹© `aerobie-aeropress-user-manual.pdf`
3. è¾“å…¥é—®é¢˜ï¼š"åº”è¯¥ä½¿ç”¨å¤šå°‘åº¦çš„æ°´å‘¢ï¼Ÿ"
4. ç‚¹å‡»"å‘é€"

**é¢„æœŸæµç¨‹**:
1. âœ… æ˜¾ç¤º toast: "æ­£åœ¨ä¸Šä¼ æ–‡æ¡£: aerobie-aeropress-user-manual.pdf..."
2. âœ… æ˜¾ç¤º toast: "æ–‡æ¡£å·²ä¸Šä¼ å¹¶å¼€å§‹ç´¢å¼•: aerobie-aeropress-user-manual.pdf"
3. âœ… æ¶ˆæ¯æ˜¾ç¤º: "[å·²ä¸Šä¼ æ–‡æ¡£: aerobie-aeropress-user-manual.pdfï¼Œæ–‡æ¡£ID: upload_xxxã€‚è¯·ä½¿ç”¨RAGå·¥å…·æŸ¥è¯¢æ­¤æ–‡æ¡£å†…å®¹ã€‚]"
4. âœ… Agent æ˜¾ç¤º: "ðŸ› ï¸ Calling tool: query_knowledge"
5. âœ… Agent è¿”å›žç­”æ¡ˆ: "æ ¹æ® AeroPress ç”¨æˆ·æ‰‹å†Œï¼ŒæŽ¨èçš„æ°´æ¸©æ˜¯ 175Â°F (çº¦ 80Â°C)..."

---

### Step 4: éªŒè¯å®Œæ•´åŠŸèƒ½

**æµ‹è¯•åœºæ™¯ 1: ç›´æŽ¥é—®ç­”**
```
é—®: "ä½ å¥½"
ç­”: "ä½ å¥½ï¼æˆ‘æ˜¯ AuroraAI..."
```
âœ… ä¸éœ€è¦æŸ¥è¯¢æ–‡æ¡£

**æµ‹è¯•åœºæ™¯ 2: æ–‡æ¡£æŸ¥è¯¢**
```
é—®: "å·¥å…·çš„å·¥ä½œæ¸©åº¦æ˜¯å¤šå°‘åº¦ï¼Ÿ"
ç­”: "æ ¹æ®æ–‡æ¡£ï¼ŒæŽ¨èæ¸©åº¦æ˜¯ 175Â°F (80Â°C)..."
```
âœ… è°ƒç”¨ RAG å·¥å…·æŸ¥è¯¢

**æµ‹è¯•åœºæ™¯ 3: å›¾ç‰‡ä¸Šä¼ **
```
ä¸Šä¼ å›¾ç‰‡ + é—®: "è¿™å¼ å›¾ç‰‡é‡Œæœ‰ä»€ä¹ˆï¼Ÿ"
ç­”: "å›¾ç‰‡ä¸­æ˜¾ç¤ºäº†..."
```
âœ… Gemini Vision åˆ†æž

**æµ‹è¯•åœºæ™¯ 4: PDF ä¸Šä¼  + æŸ¥è¯¢**
```
ä¸Šä¼  PDF + é—®: "è¿™ä¸ªæ–‡æ¡£è®²äº†ä»€ä¹ˆï¼Ÿ"
ç­”: "è¿™ä¸ªæ–‡æ¡£æ˜¯å…³äºŽ AeroPress å’–å•¡æœºçš„ä½¿ç”¨æ‰‹å†Œ..."
```
âœ… å®Œæ•´çš„ RAG æµç¨‹

---

## ðŸ“ æœ€ç»ˆç¡®è®¤

### ä»£ç æ˜¯æœ€é«˜æ•ˆã€æœ€å®Œå–„çš„å—ï¼Ÿ

**âœ… æ˜¯çš„ï¼**

1. **æž¶æž„è®¾è®¡** âœ…
   - å‰ç«¯æ‹¦æˆªæ–‡ä»¶ â†’ ä¸Šä¼ åˆ° RAG Core â†’ è½¬æ¢ä¸ºæ–‡æœ¬å¼•ç”¨
   - Agent ä¸ç›´æŽ¥å¤„ç†æ–‡ä»¶ï¼Œåªå¤„ç†æ–‡æœ¬å’Œå›¾ç‰‡
   - æ¸…æ™°çš„èŒè´£åˆ†ç¦»

2. **é”™è¯¯å¤„ç†** âœ…
   - ä¸Šä¼ å¤±è´¥æœ‰æç¤º
   - æ‰€æœ‰å¼‚å¸¸éƒ½è¢«æ•èŽ·
   - ç”¨æˆ·ä½“éªŒå‹å¥½

3. **æ€§èƒ½ä¼˜åŒ–** âœ…
   - å¼‚æ­¥å¤„ç†ï¼ˆä¸é˜»å¡ž UIï¼‰
   - åŽå°ç´¢å¼•ï¼ˆä¸ç­‰å¾…å®Œæˆï¼‰
   - æœ¬åœ° Ollamaï¼ˆé€Ÿåº¦å¿«ï¼‰

4. **æˆæœ¬ä¼˜åŒ–** âœ…
   - Ollama å®Œå…¨å…è´¹
   - Gemini å…è´¹é¢åº¦å¤§
   - æ€»æˆæœ¬çº¦ $3/æœˆ

5. **å¯ç»´æŠ¤æ€§** âœ…
   - ä»£ç æ¸…æ™°
   - æ³¨é‡Šå®Œæ•´
   - æ˜“äºŽæ‰©å±•

---

## ðŸŽ‰ æ€»ç»“

### é—®é¢˜æ ¹æº

1. âŒ `processContentBlocks` æ²¡æœ‰è¢«è°ƒç”¨
2. âŒ `processContentBlocks` é€»è¾‘ä¸å®Œæ•´
3. âŒ Vision é…ç½®ä¸æ”¯æŒ
4. âŒ protobuf ç‰ˆæœ¬è¿‡æ—§

### å·²ä¿®å¤

1. âœ… `handleSubmit` æ”¹ä¸º asyncï¼Œè°ƒç”¨ `processContentBlocks`
2. âœ… `processContentBlocks` å¤„ç†æ‰€æœ‰æ–‡ä»¶ç±»åž‹
3. âœ… Vision åˆ‡æ¢åˆ° Ollama qwen3-vl:30b
4. âœ… protobuf å‡çº§åˆ° 6.33.1

### çŽ°åœ¨å¯ä»¥æµ‹è¯•äº†ï¼

**æ‰§è¡Œå‘½ä»¤**:
```bash
# é‡å¯ Chat UI
pkill -f "next-server" && sleep 2 && cd chat-ui && npm run dev &
```

**10 ç§’åŽè®¿é—®**:
```
http://localhost:3000
```

**ä¸Šä¼  PDF å¹¶æé—®ï¼Œäº«å—å®Œæ•´çš„ RAG ä½“éªŒï¼** ðŸš€

