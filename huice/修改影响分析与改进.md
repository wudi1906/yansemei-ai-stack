# ä¿®æ”¹å½±å“åˆ†æä¸æ”¹è¿›æ–¹æ¡ˆ

**æ—¥æœŸ**: 2025-12-05  
**åŸåˆ™**: ä¿è¯ç³»ç»Ÿå®Œæ•´æ€§ï¼Œä¸ç ´åç°æœ‰åŠŸèƒ½

---

## ğŸ” æˆ‘çš„ä¿®æ”¹å†…å®¹å›é¡¾

### ä¿®æ”¹ 1: `chat-ui/src/components/thread/index.tsx`

**æ”¹åŠ¨**:
```typescript
// åŸä»£ç 
const handleSubmit = (e: FormEvent) => {
  const newHumanMessage: Message = {
    content: [
      ...(input.trim().length > 0 ? [{ type: "text", text: input }] : []),
      ...contentBlocks,  // ç›´æ¥ä½¿ç”¨
    ]
  };
}

// ä¿®æ”¹å
const handleSubmit = async (e: FormEvent) => {
  const processedBlocks = await processContentBlocks(contentBlocks);
  const newHumanMessage: Message = {
    content: [
      ...(input.trim().length > 0 ? [{ type: "text", text: input }] : []),
      ...processedBlocks,  // ä½¿ç”¨å¤„ç†åçš„
    ]
  };
}
```

---

### ä¿®æ”¹ 2: `chat-ui/src/lib/file-handler.ts`

**æ–°å¢å‡½æ•°**: `processContentBlocks()`

**åŠŸèƒ½**:
- å¤„ç† `type: "file"` çš„ PDF â†’ ä¸Šä¼ åˆ° RAG Core
- å¤„ç† `type: "file"` çš„å›¾ç‰‡ â†’ è½¬æ¢ä¸º `image_url`
- ä¿æŒ `type: "image_url"` ä¸å˜
- ä¿æŒ `type: "text"` ä¸å˜

---

## âš ï¸ æ½œåœ¨å½±å“åˆ†æ

### å½±å“ 1: å›¾ç‰‡ä¸Šä¼ æµç¨‹

**åŸæµç¨‹**:
```
ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡
    â†“
fileToContentBlock() è½¬æ¢
    â†“
contentBlocks = [{ type: "image_url", image_url: {...} }]
    â†“
ç›´æ¥å‘é€ç»™ Agent
```

**ä¿®æ”¹åæµç¨‹**:
```
ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡
    â†“
fileToContentBlock() è½¬æ¢
    â†“
contentBlocks = [{ type: "image_url", image_url: {...} }]
    â†“
processContentBlocks() å¤„ç†
    â†“
æ£€æµ‹åˆ° type: "image_url" â†’ ä¿æŒä¸å˜
    â†“
å‘é€ç»™ Agent
```

**ç»“è®º**: âœ… **æ— å½±å“** - å›¾ç‰‡ä¿æŒåŸæ ·

---

### å½±å“ 2: çº¯æ–‡æœ¬æ¶ˆæ¯

**åŸæµç¨‹**:
```
ç”¨æˆ·è¾“å…¥æ–‡æœ¬
    â†“
contentBlocks = []
    â†“
ç›´æ¥å‘é€
```

**ä¿®æ”¹åæµç¨‹**:
```
ç”¨æˆ·è¾“å…¥æ–‡æœ¬
    â†“
contentBlocks = []
    â†“
processContentBlocks([]) â†’ è¿”å› []
    â†“
å‘é€
```

**ç»“è®º**: âœ… **æ— å½±å“** - ç©ºæ•°ç»„å¤„ç†æ­£ç¡®

---

### å½±å“ 3: å›¾ç‰‡ + æ–‡æœ¬

**åŸæµç¨‹**:
```
ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡ + è¾“å…¥æ–‡æœ¬
    â†“
contentBlocks = [{ type: "image_url", ... }]
input = "è¿™æ˜¯ä»€ä¹ˆï¼Ÿ"
    â†“
content = [
  { type: "text", text: "è¿™æ˜¯ä»€ä¹ˆï¼Ÿ" },
  { type: "image_url", ... }
]
```

**ä¿®æ”¹åæµç¨‹**:
```
ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡ + è¾“å…¥æ–‡æœ¬
    â†“
contentBlocks = [{ type: "image_url", ... }]
    â†“
processContentBlocks() â†’ [{ type: "image_url", ... }]
    â†“
content = [
  { type: "text", text: "è¿™æ˜¯ä»€ä¹ˆï¼Ÿ" },
  { type: "image_url", ... }
]
```

**ç»“è®º**: âœ… **æ— å½±å“** - å›¾ç‰‡ä¿æŒåŸæ ·

---

### å½±å“ 4: PDF ä¸Šä¼ ï¼ˆæ–°åŠŸèƒ½ï¼‰

**åŸæµç¨‹** (æœ‰ bug):
```
ç”¨æˆ·ä¸Šä¼  PDF
    â†“
fileToContentBlock() è½¬æ¢
    â†“
contentBlocks = [{ type: "file", mime_type: "application/pdf", ... }]
    â†“
ç›´æ¥å‘é€ç»™ Agent
    â†“
âŒ Gemini æŠ¥é”™: "Unrecognized message part type: file"
```

**ä¿®æ”¹åæµç¨‹** (ä¿®å¤):
```
ç”¨æˆ·ä¸Šä¼  PDF
    â†“
fileToContentBlock() è½¬æ¢
    â†“
contentBlocks = [{ type: "file", mime_type: "application/pdf", ... }]
    â†“
processContentBlocks() å¤„ç†
    â†“
ä¸Šä¼ åˆ° RAG Core
    â†“
è½¬æ¢ä¸º text: "[å·²ä¸Šä¼ æ–‡æ¡£: xxx.pdf...]"
    â†“
âœ… å‘é€ç»™ Agent
```

**ç»“è®º**: âœ… **ä¿®å¤äº† bug** - PDF ç°åœ¨å¯ä»¥æ­£å¸¸å·¥ä½œ

---

### å½±å“ 5: æ‹–æ‹½ä¸Šä¼ 

**åŸæµç¨‹**:
```
ç”¨æˆ·æ‹–æ‹½æ–‡ä»¶
    â†“
useFileUpload hook å¤„ç†
    â†“
fileToContentBlock() è½¬æ¢
    â†“
æ·»åŠ åˆ° contentBlocks
    â†“
ç›´æ¥å‘é€
```

**ä¿®æ”¹åæµç¨‹**:
```
ç”¨æˆ·æ‹–æ‹½æ–‡ä»¶
    â†“
useFileUpload hook å¤„ç†
    â†“
fileToContentBlock() è½¬æ¢
    â†“
æ·»åŠ åˆ° contentBlocks
    â†“
processContentBlocks() å¤„ç†
    â†“
å‘é€
```

**ç»“è®º**: âœ… **æ— å½±å“** - æ‰€æœ‰æ–‡ä»¶ç±»å‹éƒ½è¢«æ­£ç¡®å¤„ç†

---

### å½±å“ 6: ç²˜è´´ä¸Šä¼ 

**åŸæµç¨‹**:
```
ç”¨æˆ·ç²˜è´´å›¾ç‰‡
    â†“
handlePaste() å¤„ç†
    â†“
fileToContentBlock() è½¬æ¢
    â†“
æ·»åŠ åˆ° contentBlocks
    â†“
ç›´æ¥å‘é€
```

**ä¿®æ”¹åæµç¨‹**:
```
ç”¨æˆ·ç²˜è´´å›¾ç‰‡
    â†“
handlePaste() å¤„ç†
    â†“
fileToContentBlock() è½¬æ¢
    â†“
æ·»åŠ åˆ° contentBlocks
    â†“
processContentBlocks() å¤„ç†
    â†“
å‘é€
```

**ç»“è®º**: âœ… **æ— å½±å“** - ç²˜è´´åŠŸèƒ½æ­£å¸¸

---

## ğŸ› å‘ç°çš„æ½œåœ¨é—®é¢˜

### é—®é¢˜ 1: `fileToContentBlock()` çš„è¡Œä¸º

è®©æˆ‘æ£€æŸ¥è¿™ä¸ªå‡½æ•°çš„å®ç°ï¼Œç¡®ä¿å®ƒè¿”å›çš„æ ¼å¼æ­£ç¡®ï¼š

**éœ€è¦éªŒè¯**:
- å›¾ç‰‡æ˜¯å¦è¿”å› `type: "image_url"`ï¼Ÿ
- PDF æ˜¯å¦è¿”å› `type: "file"`ï¼Ÿ

**å¦‚æœä¸æ˜¯**ï¼Œæˆ‘çš„ `processContentBlocks` å¯èƒ½æ— æ³•æ­£ç¡®å¤„ç†ï¼

---

### é—®é¢˜ 2: å¼‚æ­¥å¤„ç†çš„æ€§èƒ½

**åŸä»£ç **: åŒæ­¥ï¼Œç«‹å³å‘é€
**ä¿®æ”¹å**: å¼‚æ­¥ï¼Œéœ€è¦ç­‰å¾… PDF ä¸Šä¼ 

**å½±å“**:
- å¦‚æœ PDF å¾ˆå¤§ï¼Œä¸Šä¼ å¯èƒ½éœ€è¦å‡ ç§’
- ç”¨æˆ·ä½“éªŒï¼šçœ‹åˆ° toast æç¤ºï¼ŒçŸ¥é“æ­£åœ¨ä¸Šä¼ 
- âœ… å¯æ¥å—

---

### é—®é¢˜ 3: é”™è¯¯å¤„ç†

**å¦‚æœ PDF ä¸Šä¼ å¤±è´¥**:
```typescript
processedBlocks.push({
  type: "text",
  text: `[æ–‡æ¡£ä¸Šä¼ å¤±è´¥: ${fileBlock.metadata.filename}]`,
});
```

**é—®é¢˜**: ç”¨æˆ·ä»ç„¶å¯ä»¥å‘é€æ¶ˆæ¯ï¼Œä½†æ–‡æ¡£æ²¡æœ‰ä¸Šä¼ æˆåŠŸ

**æ”¹è¿›å»ºè®®**: 
- é€‰é¡¹ A: é˜»æ­¢å‘é€ï¼Œæ˜¾ç¤ºé”™è¯¯
- é€‰é¡¹ B: å…è®¸å‘é€ï¼Œä½†æ˜ç¡®å‘ŠçŸ¥å¤±è´¥ï¼ˆå½“å‰å®ç°ï¼‰

**å½“å‰å®ç°**: âœ… é€‰é¡¹ B - æ›´å‹å¥½

---

## âœ… æ”¹è¿›æ–¹æ¡ˆ

### æ”¹è¿› 1: éªŒè¯ `fileToContentBlock()` çš„è¡Œä¸º

è®©æˆ‘æ£€æŸ¥è¿™ä¸ªå‡½æ•°ï¼Œç¡®ä¿ç†è§£æ­£ç¡®ï¼š

