## 背景
- 目标：在 VPS 上完成 Huice 平台各组件（mcp、agent-service、rag-core、chat-ui、admin-ui）的 Docker 部署，解决 MCP 工具加载失败、依赖缺失、事件循环冲突等问题。
- 代码根目录（当前部署）：`/home/ai-stack/yansemei-ai-stack/huice`
- 关键环境变量：`SILICONFLOW_API_KEY=sk-ebuinjyygubsompogzhgmvabmtizghsuewvhvdfkohlrntyt`

## 关键改动与结论
1) mcp-server Dockerfile（`/home/ai-stack/yansemei-ai-stack/huice/mcp-server/Dockerfile`）
   - 复制本地源码：`COPY huice/rag-core/raganything ./raganything`，`COPY huice/rag-core/lightrag ./lightrag`
   - 设置 `PYTHONPATH=/app`
   - 安装 CPU 版 torch/torchvision + lightrag 依赖（json-repair、pipmaster、pypinyin、nano-vectordb、configparser、future、networkx、pandas<2.4、pydantic、python-dotenv、tenacity、tiktoken、xlsxwriter、aiohttp、docling、fastapi、google-api-core、google-genai）
   - 入口：`CMD ["python", "-m", "mcp_server_rag_anything.server", "--host", "0.0.0.0", "--port", "8001"]`
   - 结果：mcp 启动成功，日志显示 LightRAG 初始化正常，无缺包报错。

2) agent-service Dockerfile（`/home/ai-stack/yansemei-ai-stack/huice/agent-service/Dockerfile`）
   - 安装：`pip install --no-cache-dir --no-build-isolation . && pip install uvicorn[standard] fastapi python-dotenv nest_asyncio`
   - 入口：`CMD ["python","-m","uvicorn","start_server:app","--host","0.0.0.0","--port","2025"]`

3) docker-compose.yml（`/home/ai-stack/yansemei-ai-stack/huice/docker-compose.yml`）
   - 在 `agent-service` 增加环境变量：
     - `MCP_URL=http://mcp:8001`
     - `SILICONFLOW_API_KEY=sk-ebuinjyygubsompogzhgmvabmtizghsuewvhvdfkohlrntyt`
   - 服务均挂载到 `npm_default` 网络，端口映射：mcp 8001、agent-service 2025、rag-core 9621、chat-ui 3000、admin-ui 5173。

4) agent-service 异步事件循环问题（最易踩坑点）
   - 症状：`asyncio.run() cannot be called from a running event loop`，后续 `nest_asyncio` 与 `uvloop` 冲突 (`ValueError: Can't patch loop of type uvloop.Loop`)。
   - 原因：uvicorn 默认使用 uvloop，`nest_asyncio.apply()` 无法 patch；在已有事件循环中不能再 `asyncio.run()`。
   - 解决方案：移除 `nest_asyncio`，在已有 loop 运行时使用 `asyncio.run_coroutine_threadsafe`，否则 `loop.run_until_complete`。
   - 修正后的 `agent-service/src/rag/chat/tools.py`（核心逻辑）：
     ```python
     import asyncio, json
     from pathlib import Path
     from langchain_mcp_adapters.client import MultiServerMCPClient
     from langchain_core.tools import tool

     @tool
     def get_available_collections() -> str:
         """获取 collections.json 中定义的集合列表，返回 JSON 字符串。"""
         current_dir = Path(__file__).parent
         collections_file = current_dir / "collections.json"
         with open(collections_file, "r", encoding="utf-8") as f:
             collections = json.load(f)
         return json.dumps(collections, ensure_ascii=False, indent=2)

     def get_mcp_rag_tools():
         """获取 MCP RAG 工具，带重试机制"""
         import time

         async def _fetch_tools():
             client = MultiServerMCPClient(
                 {"mcp-server-rag": {"url": "http://127.0.0.1:8001/sse", "transport": "sse"}}
             )
             return await client.get_tools()

         max_retries = 5
         for attempt in range(max_retries):
             try:
                 loop = asyncio.get_event_loop()
                 if loop.is_running():
                     future = asyncio.run_coroutine_threadsafe(_fetch_tools(), loop)
                     tools = future.result()
                 else:
                     tools = loop.run_until_complete(_fetch_tools())
                 if tools:
                     print(f"✅ Loaded {len(tools)} MCP tools")
                     return tools
                 else:
                     print(f"⚠️ Attempt {attempt+1}/{max_retries}: empty tools")
             except Exception as e:
                 print(f"⚠️ Attempt {attempt+1}/{max_retries} failed: {e}")
             if attempt < max_retries - 1:
                 time.sleep(2)
         print("❌ Failed to fetch MCP tools after all retries.")
         return []
     ```

5) 当前状态
   - mcp：启动正常，日志显示 LightRAG 初始化完成。
   - agent-service：已安装 nest_asyncio，但需按上面代码去掉 nest_asyncio 使用，避免 uvloop 冲突；需重建镜像。
   - 其他服务（rag-core/chat-ui/admin-ui）：compose 已配置，未发现新报错。

## 近期操作命令（复用模板）
- 重建 mcp + agent-service：
  ```bash
  cd /home/ai-stack/yansemei-ai-stack/huice
  docker compose -f docker-compose.yml build --no-cache mcp agent-service
  docker compose -f docker-compose.yml up -d mcp agent-service
  docker compose -f docker-compose.yml logs -f mcp
  docker compose -f docker-compose.yml logs -f agent-service
  ```
- 若仅改 agent-service 代码/依赖：
  ```bash
  cd /home/ai-stack/yansemei-ai-stack/huice
  docker compose -f docker-compose.yml build --no-cache agent-service
  docker compose -f docker-compose.yml up -d agent-service
  docker compose -f docker-compose.yml logs -f agent-service
  ```

## 常见报错与对应修复
- `ModuleNotFoundError: json_repair/pipmaster/pypinyin/...`：在 mcp-server Dockerfile 中补充依赖（已处理）。
- `ModuleNotFoundError: langgraph`：确保 agent-service 安装 pyproject 依赖（已处理）。
- `ValueError: Function must have a docstring if description not provided.`：`@tool` 的函数必须有 docstring（已给 get_available_collections 增加）。
- `asyncio.run() cannot be called from a running event loop` / `nest_asyncio ValueError with uvloop`：按上方最终版 tools.py 逻辑，使用 `run_coroutine_threadsafe`，不要 patch uvloop。

## 下一步建议
1) 立即应用最终版 tools.py（移除 nest_asyncio，使用 run_coroutine_threadsafe），重建 agent-service，确认 MCP 工具成功加载。
2) 确认 mcp/agent-service 日志无报错后，再启动/验证 chat-ui、admin-ui。
3) 后续安全加固：收紧 CORS/鉴权、检查暴露端口、证书/域名配置等。

## 记录人
- 日期：2025-12-25
- 维护人：Ops/AI 助手
