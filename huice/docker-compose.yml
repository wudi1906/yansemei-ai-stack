# Huice AI Platform - Docker Compose Configuration
# 双轨制架构: FastGPT (客户友好) + Huice (高级能力)
# 
# 部署位置: VPS /home/ai-stack/yansemei-ai-stack/huice/
# 最后更新: 2025-12-26
#
# 架构说明:
# - 轨道 A (FastGPT): 面向普通客户，低代码可视化，客户可自维护
# - 轨道 B (Huice): 面向高端客户，LangGraph Agent + 知识图谱 RAG
#
# 重要说明:
# - NEXT_PUBLIC_* 环境变量是给浏览器端使用的，必须使用公网域名
# - 服务间内部通信使用 Docker 网络名称（如 agent-service:2025）
# - 所有服务都连接到 npm_default 网络，与 NPM 共享网络

networks:
  npm_default:
    external: true

volumes:
  pg_data:
  mongo_data:
  redis_data:
  oneapi_data:

services:
  # ============================================
  # 轨道 A: FastGPT 客户友好层
  # ============================================

  # PostgreSQL - FastGPT 向量数据库
  pg:
    image: pgvector/pgvector:pg15
    container_name: pg
    restart: unless-stopped
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: FastGPT2025Secure!
      POSTGRES_DB: fastgpt
    volumes:
      - pg_data:/var/lib/postgresql/data
    networks: [npm_default]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # MongoDB - FastGPT 文档数据库
  mongo:
    image: mongo:5.0.18
    container_name: mongo
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: FastGPT2025Secure!
    volumes:
      - mongo_data:/data/db
    networks: [npm_default]
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis - FastGPT 缓存
  redis:
    image: redis:7-alpine
    container_name: redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    command: redis-server --requirepass FastGPT2025Secure!
    volumes:
      - redis_data:/data
    networks: [npm_default]
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "FastGPT2025Secure!", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # OneAPI - 模型路由与配额管理
  oneapi:
    image: justsong/one-api:latest
    container_name: oneapi
    restart: unless-stopped
    ports:
      - "3002:3000"
    environment:
      TZ: Asia/Shanghai
      SQL_DSN: postgres://postgres:FastGPT2025Secure!@pg:5432/oneapi?sslmode=disable
      REDIS_CONN_STRING: redis://:FastGPT2025Secure!@redis:6379
      SESSION_SECRET: oneapi-session-secret-2025
    volumes:
      - oneapi_data:/data
    depends_on:
      pg:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks: [npm_default]

  # FastGPT - 客户友好型 AI 应用平台
  # 注意: 使用 v4.8.1 稳定版，最新版需要 plugin 服务
  # 实际部署使用 docker run 命令，挂载 config.json
  fastgpt:
    image: registry.cn-hangzhou.aliyuncs.com/fastgpt/fastgpt:v4.8.1
    container_name: fastgpt
    restart: unless-stopped
    ports:
      - "3001:3000"
    env_file:
      - ./fastgpt.env
    volumes:
      - ./fastgpt-config.json:/app/data/config.json:ro
    depends_on:
      pg:
        condition: service_healthy
      mongo:
        condition: service_healthy
      redis:
        condition: service_healthy
      oneapi:
        condition: service_started
    networks: [npm_default]

  # ============================================
  # 轨道 B: Huice 高级能力层
  # ============================================
  # RAG Core - LightRAG 知识图谱引擎
  rag-core:
    build:
      context: ./rag-core
    container_name: huice-rag-core
    ports: ["9621:9621"]
    volumes:
      - ./rag-core/.env:/app/.env:ro
      - ./rag_storage:/app/rag_storage
      - ./inputs:/app/inputs
    networks: [npm_default]
    restart: unless-stopped

  # MCP Server - RAG 工具服务
  mcp:
    build:
      context: ..
      dockerfile: huice/mcp-server/Dockerfile
    container_name: huice-mcp
    ports: ["8001:8001"]
    environment:
      - RAG_CORE_API_URL=http://rag-core:9621
      - RAG_CORE_API_KEY=75f5b78ed421819d66394293e843872ef2fc2b74909da6b5edcce7d8f1eb33fa
    depends_on: [rag-core]
    networks: [npm_default]
    restart: unless-stopped

  # Agent Service - LangGraph Agent 大脑
  agent-service:
    build:
      context: ./agent-service
    container_name: huice-agent-service
    ports: ["2025:2025"]
    volumes:
      - ./agent-service/.env:/app/.env:ro
    environment:
      - MCP_URL=http://mcp:8001
      - RAG_API_BASE=http://rag-core:9621
    depends_on: [mcp, rag-core]
    networks: [npm_default]
    restart: unless-stopped

  # Chat UI - AuroraAI 对话界面
  # 重要: NEXT_PUBLIC_API_URL 必须使用公网域名！
  chat-ui:
    build:
      context: ./chat-ui
    container_name: huice-chat-ui
    ports: ["3000:3000"]
    environment:
      - NEXT_PUBLIC_API_URL=https://agent.yansemei.com
      - NEXT_PUBLIC_ASSISTANT_ID=chat_agent
    depends_on: [agent-service]
    networks: [npm_default]
    restart: unless-stopped

  # Admin UI - LightRAG 管理界面
  admin-ui:
    build:
      context: ./admin-ui
    container_name: huice-admin-ui
    ports: ["5173:5173"]
    environment:
      - VITE_BACKEND_URL=http://rag-core:9621
    depends_on: [rag-core]
    networks: [npm_default]
    restart: unless-stopped
